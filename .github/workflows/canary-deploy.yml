name: Canary Deploy

on:
  push:
    branches: [ canary ]
  workflow_dispatch:

concurrency:
  group: canary-deploy
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy canary
    runs-on: [self-hosted, canary]
    steps:
      - name: Checkout gastown
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Read canary manifest
        run: |
          python - <<'PY' >> "$GITHUB_ENV"
          manifest = {}
          section = None
          with open('deploy/canary-manifest.yaml', 'r') as handle:
            for line in handle:
              line = line.strip()
              if not line or line.startswith('#'):
                continue
              if line.endswith(':') and ' ' not in line[:-1]:
                section = line[:-1]
                manifest[section] = {}
                continue
              if ':' in line:
                key, value = line.split(':', 1)
                key = key.strip()
                value = value.strip().strip('"')
                if section and key in ('repo', 'ref'):
                  manifest[section][key] = value
                else:
                  manifest[key] = value
          env_repo = manifest.get('env_config', {}).get('repo', 'shisuiki/env-config')
          env_ref = manifest.get('env_config', {}).get('ref', '')
          gastown_ref = manifest.get('gastown_ref', '')
          print(f"ENV_CONFIG_REPO={env_repo}")
          print(f"ENV_CONFIG_REF={env_ref}")
          print(f"GASTOWN_REF={gastown_ref}")
          PY

      - name: Validate env-config ref
        run: |
          if [ -z "$ENV_CONFIG_REF" ]; then
            echo "env-config ref missing in deploy/canary-manifest.yaml"
            exit 1
          fi

      - name: Checkout env-config
        uses: actions/checkout@v6
        with:
          repository: ${{ env.ENV_CONFIG_REPO }}
          ref: ${{ env.ENV_CONFIG_REF }}
          path: env-config

      - name: Deploy canary
        env:
          GT_WEB_AUTH_TOKEN: ${{ secrets.GT_WEB_AUTH_TOKEN_CANARY }}
          GT_ROOT: ${{ secrets.GT_ROOT_CANARY }}
          CANARY_PORT: ${{ secrets.GT_CANARY_PORT }}
          GASTOWN_REF: ${{ env.GASTOWN_REF }}
          ENV_CONFIG_REF: ${{ env.ENV_CONFIG_REF }}
          ENV_CONFIG_DIR: ${{ github.workspace }}/env-config
        run: |
          ./deploy/canary-deploy.sh
