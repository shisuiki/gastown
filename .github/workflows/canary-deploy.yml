name: Canary Deploy Trigger

on:
  push:
    branches:
      - canary
  workflow_dispatch:
  repository_dispatch:
    types: [dependency-updated]

env:
  CANARY_CONTAINER: gastown-canary
  CANARY_COMMAND_TIMEOUT: '300'
  CANARY_RETRY_ATTEMPTS: '3'
  CANARY_RETRY_BACKOFF_SECONDS: '10'
  # Use canary workspace for GTRuntime dependencies
  GT_ROOT: /home/shisui/gt-canary

jobs:
  validate-dependencies:
    name: Validate Dependencies
    runs-on: [self-hosted, canary]
    outputs:
      gtruntime_sha: ${{ steps.deps.outputs.gtruntime_sha }}
    steps:
      - name: Sync canary workspace
        run: |
          echo "=== Syncing canary workspace ==="
          cd /home/shisui/gt-canary
          git fetch origin canary
          git reset --hard origin/canary
          echo "Canary workspace synced"

      - name: Capture dependency versions
        id: deps
        run: |
          GTRUNTIME_SHA=$(cd /home/shisui/gt-canary && git rev-parse HEAD)
          echo "gtruntime_sha=$GTRUNTIME_SHA" >> $GITHUB_OUTPUT
          echo "GTRuntime SHA: $GTRUNTIME_SHA"

          echo "=== Formulas available ==="
          ls /home/shisui/gt-canary/.beads/formulas/*.formula.toml 2>/dev/null | wc -l
          echo "formulas found"

      - name: Validate canary workspace
        run: |
          # Ensure required directories exist
          if [ ! -d "/home/shisui/gt-canary/.beads/formulas" ]; then
            echo "::error::Canary workspace missing .beads/formulas"
            exit 1
          fi
          if [ ! -d "/home/shisui/gt-canary/gt_runtime_doc" ]; then
            echo "::error::Canary workspace missing gt_runtime_doc"
            exit 1
          fi
          echo "Canary workspace validated"

  deploy-trigger:
    needs: validate-dependencies
    runs-on: [self-hosted, canary]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Make helper executable
        run: chmod +x scripts/canary-docker-exec.sh scripts/canary-command-retry.sh

      - name: Log dependency info
        run: |
          echo "=== Deployment Info ==="
          echo "GTRuntime SHA: ${{ needs.validate-dependencies.outputs.gtruntime_sha }}"
          echo "GT_ROOT: $GT_ROOT"
          echo "Trigger: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "Source: ${{ github.event.client_payload.source }}"
          fi

      - name: Health check
        run: scripts/canary-command-retry.sh --command health --whitelist health,config,migrate,smoke

      - name: Config reload
        run: scripts/canary-command-retry.sh --command config --whitelist health,config,migrate,smoke

      - name: Migrations
        run: scripts/canary-command-retry.sh --command migrate --whitelist health,config,migrate,smoke

      - name: Smoke test
        run: scripts/canary-command-retry.sh --command smoke --whitelist health,config,migrate,smoke

  rollback:
    if: failure()
    needs: deploy-trigger
    runs-on: ubuntu-latest
    env:
      CANARY_ROLLBACK_COMMANDS: |
        git reset --hard origin/main;;gt config reload
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Make helper executable
        run: chmod +x scripts/canary-docker-exec.sh scripts/canary-alert.sh

      - name: Rollback conduit
        run: scripts/canary-docker-exec.sh --command rollback

  alert-on-failure:
    needs: rollback
    if: failure()
    runs-on: ubuntu-latest
    env:
      CANARY_ALERT_EMAIL: guest@example.com
      CANARY_ALERT_WEBHOOK: https://example.com/hook
      CANARY_ALERT_SOURCE: Canary Deploy
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Make helper executable
        run: chmod +x scripts/canary-alert.sh

      - name: Send alert
        run: scripts/canary-alert.sh
