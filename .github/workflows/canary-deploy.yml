name: Canary Deploy Trigger

on:
  push:
    branches:
      - canary
  workflow_dispatch:

env:
  CANARY_CONTAINER: gastown-canary
  CANARY_COMMAND_TIMEOUT: '300'

jobs:
  deploy-trigger:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Make helper executable
        run: chmod +x scripts/canary-docker-exec.sh

      - name: Health check
        run: scripts/canary-docker-exec.sh --command health

      - name: Config reload
        run: scripts/canary-docker-exec.sh --command config

      - name: Migrations
        run: scripts/canary-docker-exec.sh --command migrate

      - name: Smoke test
        run: scripts/canary-docker-exec.sh --command smoke

  rollback:
    if: failure()
    needs: deploy-trigger
    runs-on: ubuntu-latest
    env:
      CANARY_ROLLBACK_COMMANDS: |
        git reset --hard origin/main;;gt config reload
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Make helper executable
        run: chmod +x scripts/canary-docker-exec.sh

      - name: Rollback conduit
        run: scripts/canary-docker-exec.sh --command rollback
