# syntax=docker/dockerfile:1
# Full Gas Town Dockerfile - includes mayor, deacon, witness, refinery
FROM golang:1.24-alpine AS builder

RUN apk add --no-cache git make

WORKDIR /src
COPY go.mod go.sum ./
RUN go mod download
COPY . .

RUN make build
RUN go install github.com/steveyegge/beads/cmd/bd@latest

FROM alpine:3.20

# Install runtime dependencies including tmux for session management
RUN apk add --no-cache \
    ca-certificates \
    bash \
    tmux \
    git \
    curl \
    jq \
    nodejs \
    npm \
    && addgroup -S gastown \
    && adduser -S -G gastown -u 10001 -s /bin/bash gastown \
    && npm install -g @anthropic-ai/claude-code

ENV GT_ROOT=/gt
ENV HOME=/home/gastown
WORKDIR /gt

COPY --from=builder /src/gt /usr/local/bin/gt
COPY --from=builder /go/bin/bd /usr/local/bin/bd
COPY deploy/entrypoint-full.sh /usr/local/bin/entrypoint.sh

# Create necessary directories
RUN mkdir -p /home/gastown/.gt /home/gastown/.config \
    && chown -R gastown:gastown /home/gastown

USER gastown
EXPOSE 8080

# Health check verifies daemon + deacon are running
HEALTHCHECK --interval=30s --timeout=10s --start-period=120s --retries=5 \
    CMD /usr/local/bin/gt daemon status && tmux has-session -t hq-deacon 2>/dev/null

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["full"]
