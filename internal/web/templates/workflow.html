<!DOCTYPE html>
<html lang="en">
<head>
    {{template "head" .}}
    <title>Workflow - Gas Town</title>
    <style>
        .hook-status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .hook-empty {
            background: rgba(100, 100, 100, 0.2);
            border: 1px dashed var(--border);
        }
        .hook-active {
            background: rgba(74, 222, 128, 0.15);
            border: 1px solid var(--green);
        }
        .hook-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        .hook-content {
            font-size: 1.1rem;
        }
        .hook-id {
            font-family: monospace;
            color: var(--green);
        }
        .priority-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 5px;
        }
        .priority-1 { background: var(--red); color: var(--bg-dark); }
        .priority-2 { background: var(--yellow); color: var(--bg-dark); }
        .priority-3 { background: var(--green); color: var(--bg-dark); }
        .priority-4 { background: var(--text-secondary); color: var(--bg-dark); }
        .type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            margin-right: 5px;
        }
        .issue-row {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .issue-row:last-child {
            border-bottom: none;
        }
        .issue-row:hover {
            background: rgba(255, 255, 255, 0.02);
        }
        .issue-id {
            font-family: monospace;
            color: var(--text-primary);
            min-width: 80px;
        }
        .issue-title {
            flex: 1;
            color: var(--text-secondary);
        }
        .section-icon {
            margin-right: 8px;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .section-header:hover {
            opacity: 0.8;
        }
        .collapse-icon {
            transition: transform 0.2s;
        }
        .collapse-icon.collapsed {
            transform: rotate(-90deg);
        }
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--green);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .refresh-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            font-size: 1rem;
        }
        .refresh-btn:hover {
            color: var(--text-primary);
        }
    </style>
</head>
<body x-data="workflow()">
    {{template "nav" .}}

    <div class="container">
        <div class="card" style="margin-bottom: 20px;">
            <div class="section-header" @click="sections.hook = !sections.hook">
                <h2><span class="section-icon">ü™ù</span>Current Hook</h2>
                <span class="collapse-icon" :class="{ 'collapsed': !sections.hook }">‚ñº</span>
            </div>
            <div x-show="sections.hook" x-collapse>
                <div style="margin-top: 15px;">
                    <template x-if="loading.hook">
                        <div class="hook-status hook-empty">
                            <span class="loading-spinner"></span> Loading...
                        </div>
                    </template>
                    <template x-if="!loading.hook">
                        <div :class="hookStatus.has_work ? 'hook-status hook-active' : 'hook-status hook-empty'">
                            <template x-if="!hookStatus.has_work">
                                <div>
                                    <div class="hook-label">Hook Status</div>
                                    <div class="hook-content">No work currently hooked</div>
                                    <p class="text-muted" style="margin-top: 10px; font-size: 0.85rem;">
                                        Check mail or use <code>gt sling</code> to assign work
                                    </p>
                                </div>
                            </template>
                            <template x-if="hookStatus.has_work">
                                <div>
                                    <div class="hook-label" x-text="(hookStatus.work_type === 'molecule' ? 'üì¶ Molecule' : 'üì¨ Mail') + ' Hooked'"></div>
                                    <div class="hook-content">
                                        <span class="hook-id" x-text="hookStatus.work_id"></span>
                                        <template x-if="hookStatus.work_title">
                                            <br><span class="text-secondary" x-text="hookStatus.work_title"></span>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <div class="section-header" @click="sections.ready = !sections.ready">
                    <h2><span class="section-icon">üìã</span>Ready Issues</h2>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button class="refresh-btn" @click.stop="loadReadyIssues()" title="Refresh">üîÑ</button>
                        <span class="collapse-icon" :class="{ 'collapsed': !sections.ready }">‚ñº</span>
                    </div>
                </div>
                <div x-show="sections.ready" x-collapse>
                    <p class="text-muted" style="font-size: 0.85rem; margin: 10px 0;">Issues with no blockers</p>
                    <template x-if="loading.ready">
                        <p><span class="loading-spinner"></span> Loading...</p>
                    </template>
                    <template x-if="!loading.ready && readyIssues.length === 0">
                        <p class="text-muted">No ready issues</p>
                    </template>
                    <template x-if="!loading.ready && readyIssues.length > 0">
                        <div>
                            <template x-for="issue in readyIssues" :key="issue.id">
                                <a :href="'/bead/' + issue.id" class="issue-row" style="text-decoration: none; color: inherit;">
                                    <span class="priority-badge" :class="'priority-' + issue.priority" x-text="'P' + issue.priority"></span>
                                    <span class="type-badge" x-text="issue.type"></span>
                                    <span class="issue-id" x-text="issue.id"></span>
                                    <span class="issue-title" x-text="issue.title"></span>
                                </a>
                            </template>
                        </div>
                    </template>
                </div>
            </div>

            <div class="card">
                <div class="section-header" @click="sections.convoys = !sections.convoys">
                    <h2><span class="section-icon">üöö</span>Active Convoys</h2>
                    <span class="collapse-icon" :class="{ 'collapsed': !sections.convoys }">‚ñº</span>
                </div>
                <div x-show="sections.convoys" x-collapse id="convoys-list">
                    <div style="margin-top: 10px;">Loading...</div>
                </div>
            </div>
        </div>

        <div class="card" style="margin-top: 20px;">
            <div class="section-header" @click="sections.commits = !sections.commits">
                <h2><span class="section-icon">üìù</span>Recent Commits</h2>
                <span class="collapse-icon" :class="{ 'collapsed': !sections.commits }">‚ñº</span>
            </div>
            <div x-show="sections.commits" x-collapse id="commits-list" style="max-height: 300px; overflow-y: auto; margin-top: 10px;">
                Loading...
            </div>
        </div>
    </div>

    {{template "scripts" .}}
    <script>
        function workflow() {
            return {
                sections: {
                    hook: true,
                    ready: true,
                    convoys: true,
                    commits: true
                },
                loading: {
                    hook: true,
                    ready: true
                },
                hookStatus: {
                    has_work: false,
                    work_type: 'none',
                    work_id: '',
                    work_title: ''
                },
                readyIssues: [],

                init() {
                    this.loadHookStatus();
                    this.loadReadyIssues();
                    loadConvoys();
                    loadCommits();

                    // Refresh periodically
                    setInterval(() => this.loadHookStatus(), 10000);
                    setInterval(() => this.loadReadyIssues(), 30000);
                    setInterval(loadConvoys, 30000);
                    setInterval(loadCommits, 60000);
                },

                async loadHookStatus() {
                    this.loading.hook = true;
                    try {
                        const res = await fetch('/api/workflow/hook');
                        this.hookStatus = await res.json();
                    } catch (e) {
                        console.error('Failed to load hook status:', e);
                    }
                    this.loading.hook = false;
                },

                async loadReadyIssues() {
                    this.loading.ready = true;
                    try {
                        const res = await fetch('/api/workflow/ready');
                        const data = await res.json();
                        this.readyIssues = data.issues || [];
                    } catch (e) {
                        console.error('Failed to load ready issues:', e);
                    }
                    this.loading.ready = false;
                }
            };
        }

        async function loadConvoys() {
            try {
                const res = await fetch('/api/convoys');
                const convoys = await res.json();
                document.getElementById('convoys-list').innerHTML =
                    '<div style="margin-top: 10px;">' + renderConvoysTable(convoys) + '</div>';
            } catch (e) {
                document.getElementById('convoys-list').innerHTML =
                    '<p class="text-danger">Error: ' + escapeHtml(e.message) + '</p>';
            }
        }

        async function loadCommits() {
            try {
                const res = await fetch('/api/activity');
                const data = await res.json();
                document.getElementById('commits-list').innerHTML = renderCommitsTable(data.commits);
            } catch (e) {
                document.getElementById('commits-list').innerHTML =
                    '<p class="text-danger">Error: ' + escapeHtml(e.message) + '</p>';
            }
        }
    </script>
</body>
</html>
