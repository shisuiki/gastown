<!DOCTYPE html>
<html lang="en">
<head>
    {{template "head" .}}
    <title>Mail Center - Gas Town</title>
</head>
<body>
    {{template "nav" .}}

    <div class="container">
        <div class="card mail-header">
            <h2>Mail Center</h2>
            <p class="text-muted">Auto-refreshes every 30 seconds.</p>
        </div>

        <div class="mail-layout">
            <div class="card mail-agents-panel">
                <div class="mail-panel-header">
                    <div>
                        <h3>Agents</h3>
                        <div class="text-muted" id="mail-last-updated">—</div>
                    </div>
                </div>
                <div id="mail-agents-list" class="mail-agents-list">
                    <p class="text-muted">Loading agents...</p>
                </div>
            </div>

            <div class="mail-content">
                <div class="card mail-column">
                    <div class="mail-column-header">
                        <div>
                            <h3>Queue</h3>
                            <div class="text-muted" id="mail-queue-count">0 messages</div>
                        </div>
                    </div>
                    <div id="mail-queue-list" class="mail-column-body">
                        <p class="mail-empty">Select an agent to view queue items.</p>
                    </div>
                </div>

                <div class="card mail-column">
                    <div class="mail-column-header">
                        <div>
                            <h3>Inbox</h3>
                            <div class="text-muted" id="mail-inbox-count">0 messages</div>
                        </div>
                    </div>
                    <div id="mail-inbox-list" class="mail-column-body">
                        <p class="mail-empty">Select an agent to view inbox.</p>
                    </div>
                </div>

                <div class="card mail-column">
                    <div class="mail-column-header">
                        <div>
                            <h3>Archive</h3>
                            <div class="text-muted" id="mail-archive-count">0 messages</div>
                        </div>
                    </div>
                    <div id="mail-archive-list" class="mail-column-body">
                        <p class="mail-empty">Select an agent to view archive.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {{template "scripts" .}}
    <script>
        const mailLimit = 200;
        const refreshIntervalMs = 30000;
        let agents = [];
        let selectedAgent = '';
        let refreshInFlight = false;

        function formatTimestamp(ts) {
            if (!ts) return '-';
            const date = new Date(ts);
            if (Number.isNaN(date.getTime())) return '-';
            return date.toLocaleString();
        }

        function truncateText(text, maxLen) {
            if (!text) return '';
            if (text.length <= maxLen) return text;
            return text.slice(0, maxLen - 1) + '…';
        }

        function updateLastUpdated() {
            const el = document.getElementById('mail-last-updated');
            if (!el) return;
            el.textContent = 'Updated ' + new Date().toLocaleTimeString();
        }

        async function loadAgents() {
            try {
                const res = await fetch('/api/agents/list');
                const data = await res.json();
                agents = Array.isArray(data) ? data : [];
            } catch (e) {
                agents = [];
            }

            if (!selectedAgent && agents.length > 0) {
                selectedAgent = agents[0].address;
            }

            if (selectedAgent && agents.length > 0) {
                const exists = agents.some(agent => agent.address === selectedAgent);
                if (!exists) {
                    selectedAgent = agents[0].address;
                }
            }

            renderAgentsList();
        }

        function renderAgentsList() {
            const list = document.getElementById('mail-agents-list');
            if (!list) return;

            if (!agents.length) {
                list.innerHTML = '<p class="mail-empty">No agents available.</p>';
                return;
            }

            list.innerHTML = agents.map(agent => {
                const unread = typeof agent.unread === 'number' ? agent.unread : 0;
                const queueCount = typeof agent.queue_count === 'number' ? agent.queue_count : 0;
                const isActive = agent.address === selectedAgent;
                const badges = [
                    '<span class="mail-badge mail-badge-unread">Unread ' + unread + '</span>'
                ];
                if (queueCount > 0) {
                    badges.push('<span class="mail-badge mail-badge-queue">Queue ' + queueCount + '</span>');
                }
                return (
                    '<div class="mail-agent-item' + (isActive ? ' active' : '') + '" onclick="selectAgent(\'' +
                    escapeHtml(agent.address) + '\')">' +
                        '<div class="mail-agent-title">' +
                            '<span class="mail-agent-name">' + escapeHtml(agent.name || agent.address) + '</span>' +
                            '<span class="mail-agent-type">' + escapeHtml(agent.type || '') + '</span>' +
                        '</div>' +
                        '<div class="mail-agent-badges">' + badges.join('') + '</div>' +
                    '</div>'
                );
            }).join('');
        }

        function selectAgent(address) {
            if (!address || address === selectedAgent) {
                return;
            }
            selectedAgent = address;
            renderAgentsList();
            loadAgentView();
        }

        function setCountText(elementId, showing, total, hasMore) {
            const el = document.getElementById(elementId);
            if (!el) return;
            if (total === 0) {
                el.textContent = '0 messages';
                return;
            }
            let text = showing + ' of ' + total;
            if (hasMore) {
                text += ' (limited)';
            }
            el.textContent = text;
        }

        function renderQueueList(messages, total, hasMore) {
            const list = document.getElementById('mail-queue-list');
            if (!list) return;
            setCountText('mail-queue-count', messages.length, total, hasMore);
            if (!messages.length) {
                list.innerHTML = '<p class="mail-empty">No queued messages.</p>';
                return;
            }
            list.innerHTML = messages.map(msg => {
                const queueName = msg.queue ? 'Queue: ' + msg.queue : 'Queue item';
                return (
                    '<div class="mail-message-card">' +
                        '<div class="mail-message-title">' + escapeHtml(queueName) + '</div>' +
                        '<div class="mail-message-meta">' +
                            'From: ' + escapeHtml(msg.from || 'unknown') + ' · ' +
                            escapeHtml(formatTimestamp(msg.timestamp)) +
                        '</div>' +
                        '<div class="mail-message-body">' + escapeHtml(truncateText(msg.subject || 'No subject', 120)) + '</div>' +
                        '<div class="mail-message-body">' + escapeHtml(truncateText(msg.body || '', 240)) + '</div>' +
                    '</div>'
                );
            }).join('');
        }

        function renderInboxList(messages, total, hasMore) {
            const list = document.getElementById('mail-inbox-list');
            if (!list) return;
            setCountText('mail-inbox-count', messages.length, total, hasMore);
            if (!messages.length) {
                list.innerHTML = '<p class="mail-empty">No inbox messages.</p>';
                return;
            }
            list.innerHTML = messages.map(msg => {
                const isRead = msg.read === true;
                const stateLabel = isRead ? 'Already Read' : 'Unread';
                const stateClass = isRead ? 'read' : 'unread';
                return (
                    '<div class="mail-message-card">' +
                        '<div class="mail-message-title">' +
                            '<span class="mail-state ' + stateClass + '">[' + stateLabel + ']</span>' +
                            escapeHtml(msg.subject || 'No subject') +
                        '</div>' +
                        '<div class="mail-message-meta">' +
                            'From: ' + escapeHtml(msg.from || 'unknown') + ' · ' +
                            escapeHtml(formatTimestamp(msg.timestamp)) +
                        '</div>' +
                        '<div class="mail-message-body">' + escapeHtml(truncateText(msg.body || '', 280)) + '</div>' +
                        '<div class="mail-message-actions">' +
                            '<button class="btn btn-sm ' + (isRead ? 'btn-secondary' : 'btn-primary') + '" onclick="toggleRead(\'' +
                                escapeHtml(msg.id) + '\', ' + isRead + ')">' + (isRead ? 'Mark Unread' : 'Mark Read') + '</button>' +
                            '<button class="btn btn-sm btn-danger" onclick="archiveMessage(\'' + escapeHtml(msg.id) + '\')">Archive</button>' +
                        '</div>' +
                    '</div>'
                );
            }).join('');
        }

        function renderArchiveList(messages, total, hasMore) {
            const list = document.getElementById('mail-archive-list');
            if (!list) return;
            setCountText('mail-archive-count', messages.length, total, hasMore);
            if (!messages.length) {
                list.innerHTML = '<p class="mail-empty">No archived messages.</p>';
                return;
            }
            list.innerHTML = messages.map(msg => {
                return (
                    '<div class="mail-message-card">' +
                        '<div class="mail-message-title">' + escapeHtml(msg.subject || 'No subject') + '</div>' +
                        '<div class="mail-message-meta">' +
                            'From: ' + escapeHtml(msg.from || 'unknown') + ' · ' +
                            escapeHtml(formatTimestamp(msg.timestamp)) +
                        '</div>' +
                        '<div class="mail-message-body">' + escapeHtml(truncateText(msg.body || '', 260)) + '</div>' +
                    '</div>'
                );
            }).join('');
        }

        async function loadAgentView() {
            if (!selectedAgent) {
                return;
            }

            const queueList = document.getElementById('mail-queue-list');
            const inboxList = document.getElementById('mail-inbox-list');
            const archiveList = document.getElementById('mail-archive-list');

            if (queueList) queueList.innerHTML = '<p class="mail-empty">Loading...</p>';
            if (inboxList) inboxList.innerHTML = '<p class="mail-empty">Loading...</p>';
            if (archiveList) archiveList.innerHTML = '<p class="mail-empty">Loading...</p>';

            try {
                const res = await fetch('/api/mail/view?agent=' + encodeURIComponent(selectedAgent) + '&limit=' + mailLimit);
                const data = await res.json();

                if (data.error) {
                    const msg = '<p class="mail-empty">Error: ' + escapeHtml(data.error) + '</p>';
                    if (queueList) queueList.innerHTML = msg;
                    if (inboxList) inboxList.innerHTML = msg;
                    if (archiveList) archiveList.innerHTML = msg;
                    return;
                }

                renderQueueList(Array.isArray(data.queue) ? data.queue : [], data.queue_total || 0, data.queue_has_more);
                renderInboxList(Array.isArray(data.inbox) ? data.inbox : [], data.inbox_total || 0, data.inbox_has_more);
                renderArchiveList(Array.isArray(data.archive) ? data.archive : [], data.archive_total || 0, data.archive_has_more);
            } catch (e) {
                const msg = '<p class="mail-empty">Error: ' + escapeHtml(e.message) + '</p>';
                if (queueList) queueList.innerHTML = msg;
                if (inboxList) inboxList.innerHTML = msg;
                if (archiveList) archiveList.innerHTML = msg;
            }
        }

        async function toggleRead(id, isRead) {
            if (!id || !selectedAgent) return;
            const endpoint = isRead ? '/api/mail/mark-unread' : '/api/mail/mark-read';
            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, agent: selectedAgent })
                });
                const data = await res.json();
                if (!data.success) {
                    alert('Failed: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
            await refreshAll();
        }

        async function archiveMessage(id) {
            if (!id || !selectedAgent) return;
            if (!confirm('Archive this message? It will be removed from the inbox.')) {
                return;
            }
            try {
                const res = await fetch('/api/mail/archive', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, agent: selectedAgent })
                });
                const data = await res.json();
                if (!data.success) {
                    alert('Failed: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
            await refreshAll();
        }

        async function refreshAll() {
            if (refreshInFlight) return;
            refreshInFlight = true;
            try {
                await loadAgents();
                await loadAgentView();
                updateLastUpdated();
            } finally {
                refreshInFlight = false;
            }
        }

        refreshAll();
        setInterval(refreshAll, refreshIntervalMs);
    </script>
</body>
</html>
