<!DOCTYPE html>
<html lang="en">
<head>
    {{template "head" .}}
    <title>Dashboard - Gas Town</title>
</head>
<body x-data="dashboard()" class="dashboard-page">
    {{template "nav" .}}

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 style="font-size: 1.2rem; color: #94a3b8;">Overview</h1>
            <span id="status-time" class="text-muted" style="font-size: 0.8rem;">Loading...</span>
        </div>

        <div class="dashboard-top">
            <div class="card">
                <h2>âš¡ Quick Actions</h2>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <button class="btn btn-success" @click="runAction('daemon-status')">Daemon Status</button>
                    <button class="btn" @click="runAction('bd-sync')">Sync Beads</button>
                    <button class="btn" @click="runAction('bd-ready')">Show Ready</button>
                    <button class="btn btn-info" @click="showConvoyModal = true">+ Convoy</button>
                    <button class="btn btn-info" @click="showIssueModal = true">+ Issue</button>
                </div>
                <pre x-show="actionOutput" x-text="actionOutput" class="terminal-output" style="margin-top: 15px; max-height: 200px;"></pre>
            </div>
            <div class="card">
                <h2>ğŸ“ˆ Weekly Limits</h2>
                <div class="card-content" id="cli-limits">Loading...</div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <h2>ğŸ’» System</h2>
                <div class="card-content" id="system-info">Loading...</div>
            </div>

            <div class="card">
                <h2>ğŸšš Convoys</h2>
                <div class="card-content" id="convoys-list">Loading...</div>
            </div>

            <div class="card">
                <h2>ğŸ¤– Active Agents</h2>
                <div class="card-content" id="agents-list">Loading...</div>
            </div>

            <div class="card">
                <h2>ğŸ­ Role Beads</h2>
                <div class="card-content" id="role-beads-list">Loading...</div>
            </div>

            <div class="card">
                <h2>ğŸ“¬ Mail</h2>
                <div class="card-content" id="mail-status">Loading...</div>
            </div>

            <div class="card">
                <h2>ğŸ§ª CI/CD</h2>
                <div class="card-content" id="cicd-status">Loading...</div>
            </div>

            <div class="card">
                <h2>ğŸ“Š Rigs</h2>
                <div class="card-content" id="rigs-list">Loading...</div>
            </div>

            <div class="card">
                <h2>ğŸ¤– Token Usage</h2>
                <div class="card-content" id="cli-usage">Loading...</div>
            </div>

            <div class="card" style="grid-column: 1 / -1;">
                <h2>ğŸ“‹ Active Beads</h2>
                <div class="card-content" id="issues-list" style="max-height: 250px; overflow-y: auto;">Loading...</div>
            </div>

            <div class="card" style="grid-column: 1 / -1;">
                <h2>ğŸ“ Recent Activity</h2>
                <div class="card-content" id="activity-list" style="max-height: 250px; overflow-y: auto;">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Create Convoy Modal -->
    <div x-cloak x-show="showConvoyModal" class="modal-backdrop" @click.self="showConvoyModal = false"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100">
        <div class="modal" @click.stop>
            <h3>ğŸšš Create Convoy</h3>
            <div class="form-group">
                <label>Convoy Title</label>
                <input type="text" x-model="convoyForm.title" class="input-field" placeholder="Enter convoy title...">
            </div>
            <div class="modal-actions">
                <button class="btn" @click="showConvoyModal = false">Cancel</button>
                <button class="btn btn-success" @click="createConvoy()" :disabled="!convoyForm.title">Create</button>
            </div>
        </div>
    </div>

    <!-- Create Issue Modal -->
    <div x-cloak x-show="showIssueModal" class="modal-backdrop" @click.self="showIssueModal = false"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100">
        <div class="modal" @click.stop>
            <h3>ğŸ“‹ Create Issue</h3>
            <div class="form-group">
                <label>Issue Title</label>
                <input type="text" x-model="issueForm.title" class="input-field" placeholder="Enter issue title...">
            </div>
            <div class="form-group">
                <label>Type</label>
                <select x-model="issueForm.type">
                    <option value="task">Task</option>
                    <option value="bug">Bug</option>
                    <option value="feature">Feature</option>
                    <option value="doc">Doc</option>
                </select>
            </div>
            <div class="form-group">
                <label>Priority</label>
                <select x-model="issueForm.priority">
                    <option value="1">P1 - Critical</option>
                    <option value="2" selected>P2 - High</option>
                    <option value="3">P3 - Normal</option>
                    <option value="4">P4 - Low</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn" @click="showIssueModal = false">Cancel</button>
                <button class="btn btn-success" @click="createIssue()" :disabled="!issueForm.title">Create</button>
            </div>
        </div>
    </div>

    {{template "scripts" .}}
    <script>
        function dashboard() {
            return {
                showConvoyModal: false,
                showIssueModal: false,
                actionOutput: '',
                convoyForm: { title: '' },
                issueForm: { title: '', type: 'task', priority: 2 },

                async runAction(action) {
                    this.actionOutput = 'Running ' + action + '...';
                    try {
                        const res = await fetch('/api/action', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: action })
                        });
                        const data = await res.json();
                        this.actionOutput = data.output || data.error || 'Done';
                    } catch (e) {
                        this.actionOutput = 'Error: ' + e.message;
                    }
                },

                async createConvoy() {
                    this.actionOutput = 'Creating convoy...';
                    this.showConvoyModal = false;
                    try {
                        const res = await fetch('/api/convoy/create', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ title: this.convoyForm.title })
                        });
                        const data = await res.json();
                        this.actionOutput = data.output || data.error || 'Convoy created';
                        this.convoyForm.title = '';
                        if (data.success) loadIssues();
                    } catch (e) {
                        this.actionOutput = 'Error: ' + e.message;
                    }
                },

                async createIssue() {
                    this.actionOutput = 'Creating issue...';
                    this.showIssueModal = false;
                    try {
                        const res = await fetch('/api/bead/create', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                title: this.issueForm.title,
                                type: this.issueForm.type,
                                priority: parseInt(this.issueForm.priority)
                            })
                        });
                        const data = await res.json();
                        this.actionOutput = data.output || data.error || 'Issue created';
                        this.issueForm.title = '';
                        if (data.success) loadIssues();
                    } catch (e) {
                        this.actionOutput = 'Error: ' + e.message;
                    }
                }
            };
        }

        // WebSocket connection for real-time updates
        let reconnectAttempts = 0;
        const maxReconnectDelay = 30000;

        function connectStatusSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const socket = new WebSocket(protocol + window.location.host + '/ws/status');

            socket.addEventListener('open', () => {
                reconnectAttempts = 0;
                document.getElementById('status-time').textContent = 'Connected';
            });

            socket.addEventListener('message', (event) => {
                try {
                    const data = JSON.parse(event.data);
                    updateUI(data);
                } catch (e) {
                    console.error('Failed to parse status update:', e);
                }
            });

            socket.addEventListener('close', () => {
                document.getElementById('status-time').textContent = 'Disconnected - reconnecting...';
                reconnectAttempts++;
                const baseDelay = Math.min(1000 * Math.pow(2, reconnectAttempts), maxReconnectDelay);
                const jitter = Math.random() * 1000;
                setTimeout(connectStatusSocket, baseDelay + jitter);
            });

            socket.addEventListener('error', (e) => {
                console.error('WebSocket error:', e);
            });
        }

        function updateUI(data) {
            document.getElementById('status-time').textContent =
                'Updated: ' + new Date(data.timestamp).toLocaleTimeString();

            const daemonIndicator = document.getElementById('daemon-status');
            if (daemonIndicator) {
                daemonIndicator.className = 'status-indicator ' +
                    (data.daemon.running ? 'status-green' : 'status-red');
            }

            document.getElementById('rigs-list').innerHTML = renderRigsTable(data.rigs);
            document.getElementById('convoys-list').innerHTML = renderConvoysTable(data.convoys);
            document.getElementById('agents-list').innerHTML = renderAgentsTable(data.agents);
            document.getElementById('mail-status').innerHTML =
                '<p>Unread: <strong>' + (data.mail.unread || 0) + '</strong></p>' +
                '<p style="margin-top: 8px;"><a href="/mail">Open Mail Center â†’</a></p>';

            const cicdEl = document.getElementById('cicd-status');
            if (cicdEl) {
                cicdEl.innerHTML = renderCICDCard(data.cicd);
            }
        }

        async function loadActivity() {
            try {
                const res = await fetch('/api/activity');
                const data = await res.json();
                document.getElementById('activity-list').innerHTML = renderCommitsTable(data.commits);
            } catch (e) {
                document.getElementById('activity-list').innerHTML = '<p class="text-danger">Error: ' + e.message + '</p>';
            }
        }

        async function loadIssues() {
            try {
                const res = await fetch('/api/issues?status=open');
                const data = await res.json();
                document.getElementById('issues-list').innerHTML = renderIssuesTable(data.issues);
            } catch (e) {
                document.getElementById('issues-list').innerHTML = '<p class="text-danger">Error: ' + e.message + '</p>';
            }
        }

        function roleTypeIcon(type) {
            const icons = { 'mayor': 'ğŸ‘”', 'deacon': 'ğŸ•', 'dog': 'ğŸ¶', 'witness': 'ğŸ‘ï¸', 'polecat': 'ğŸ±', 'crew': 'ğŸ‘·', 'refinery': 'ğŸ­' };
            return icons[type] || 'ğŸ¤–';
        }

        function renderRoleBeadsTable(beads) {
            if (!beads || beads.length === 0) {
                return '<p class="text-muted">No active role beads</p>';
            }
            return '<table><tr><th>Type</th><th>ID</th><th>Title</th><th>Status</th></tr>' +
                beads.map(b =>
                    '<tr><td>' + roleTypeIcon(b.role_type) + '</td>' +
                    '<td><a href="/bead/' + escapeHtml(b.id) + '"><code class="text-link">' + escapeHtml(b.id) + '</code></a></td>' +
                    '<td>' + escapeHtml(b.title) + '</td>' +
                    '<td><span class="badge badge-green">' + escapeHtml(b.status) + '</span></td></tr>'
                ).join('') + '</table>';
        }

        async function loadRoleBeads() {
            try {
                const res = await fetch('/api/agents');
                const data = await res.json();
                document.getElementById('role-beads-list').innerHTML = renderRoleBeadsTable(data.role_beads);
            } catch (e) {
                document.getElementById('role-beads-list').innerHTML = '<p class="text-danger">Error: ' + e.message + '</p>';
            }
        }

        function cicdBadge(status) {
            switch ((status || '').toLowerCase()) {
                case 'passing':
                    return { label: 'Passing', className: 'badge-green' };
                case 'failing':
                    return { label: 'Failing', className: 'badge-red' };
                case 'degraded':
                    return { label: 'Degraded', className: 'badge-yellow' };
                case 'running':
                    return { label: 'Running', className: 'badge-yellow' };
                case 'queued':
                    return { label: 'Queued', className: 'badge-yellow' };
                default:
                    return { label: 'Unknown', className: 'badge-yellow' };
            }
        }

        function renderCICDCard(cicd) {
            if (!cicd) {
                return '<p class="text-muted">No CI/CD data available</p>';
            }

            const badge = cicdBadge(cicd.overall_status);
            const runs = (cicd.recent_runs || []).slice(0, 5);
            const rows = runs.map(run => {
                const runBadge = cicdBadge(run.status_group);
                const time = run.created_at ? new Date(run.created_at).toLocaleString() : '-';
                return '<tr>' +
                    '<td>' + escapeHtml(run.workflow || '-') + '</td>' +
                    '<td><span class="badge ' + runBadge.className + '">' + runBadge.label + '</span></td>' +
                    '<td class="text-muted">' + escapeHtml(time) + '</td>' +
                    '</tr>';
            }).join('');

            const table = runs.length
                ? '<table><tr><th>Workflow</th><th>Status</th><th>Time</th></tr>' + rows + '</table>'
                : '<p class="text-muted">No recent runs</p>';

            return '<div style="display:flex; justify-content: space-between; align-items:center; margin-bottom:8px;">' +
                '<span class="text-muted">Overall</span>' +
                '<span class="badge ' + badge.className + '">' + badge.label + '</span>' +
                '</div>' +
                '<div class="text-muted" style="margin-bottom:10px;">' + escapeHtml(cicd.summary || '') + '</div>' +
                table +
                '<div style="margin-top: 8px;"><a href="/cicd">Open CI/CD â†’</a></div>';
        }

        async function loadCICDStatus() {
            try {
                const res = await fetch('/api/cicd/status');
                const data = await res.json();
                document.getElementById('cicd-status').innerHTML = renderCICDCard(data);
            } catch (e) {
                document.getElementById('cicd-status').innerHTML = '<p class="text-danger">Error: ' + e.message + '</p>';
            }
        }

        // Initialize
        loadActivity();
        loadIssues();
        loadRoleBeads();
        loadCICDStatus();
        loadSystemInfo('system-info');
        loadCLIUsage('cli-usage');
        loadCLILimits('cli-limits');
        setInterval(loadActivity, 30000);
        setInterval(loadIssues, 30000);
        setInterval(loadRoleBeads, 30000);
        setInterval(loadCICDStatus, 30000);
        setInterval(() => loadSystemInfo('system-info'), 60000);
        setInterval(() => loadCLIUsage('cli-usage'), 60000);
        setInterval(() => loadCLILimits('cli-limits'), 60000);
        connectStatusSocket();
    </script>
</body>
</html>
