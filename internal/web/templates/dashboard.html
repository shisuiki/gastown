<!DOCTYPE html>
<html lang="en">
<head>
    {{template "head" .}}
    <title>Dashboard - Gas Town</title>
</head>
<body>
    {{template "nav" .}}

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 style="font-size: 1.2rem; color: #94a3b8;">Overview</h1>
            <span id="status-time" class="text-muted" style="font-size: 0.8rem;">Loading...</span>
        </div>

        <div class="grid">
            <div class="card">
                <h2>üìä Rigs</h2>
                <div class="card-content" id="rigs-list">Loading...</div>
            </div>

            <div class="card">
                <h2>üöö Convoys</h2>
                <div class="card-content" id="convoys-list">Loading...</div>
            </div>

            <div class="card">
                <h2>ü§ñ Active Agents</h2>
                <div class="card-content" id="agents-list">Loading...</div>
            </div>

            <div class="card">
                <h2>üì¨ Mail</h2>
                <div class="card-content" id="mail-status">Loading...</div>
            </div>

            <div class="card" style="grid-column: 1 / -1;">
                <h2>üìã Active Issues</h2>
                <div class="card-content" id="issues-list" style="max-height: 250px; overflow-y: auto;">Loading...</div>
            </div>

            <div class="card" style="grid-column: 1 / -1;">
                <h2>üìù Recent Activity</h2>
                <div class="card-content" id="activity-list" style="max-height: 250px; overflow-y: auto;">Loading...</div>
            </div>
        </div>
    </div>

    {{template "scripts" .}}
    <script>
        // ================================================================
        // Dashboard-specific JavaScript
        // ================================================================

        let reconnectAttempts = 0;
        const maxReconnectDelay = 30000;

        function connectStatusSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const socket = new WebSocket(protocol + window.location.host + '/ws/status');

            socket.addEventListener('open', () => {
                reconnectAttempts = 0;
                document.getElementById('status-time').textContent = 'Connected';
            });

            socket.addEventListener('message', (event) => {
                try {
                    const data = JSON.parse(event.data);
                    updateUI(data);
                } catch (e) {
                    console.error('Failed to parse status update:', e);
                }
            });

            socket.addEventListener('close', () => {
                document.getElementById('status-time').textContent = 'Disconnected - reconnecting...';
                reconnectAttempts++;
                const baseDelay = Math.min(1000 * Math.pow(2, reconnectAttempts), maxReconnectDelay);
                const jitter = Math.random() * 1000;
                const delay = baseDelay + jitter;
                console.log(`WebSocket closed. Reconnecting in ${Math.round(delay)}ms (attempt ${reconnectAttempts})`);
                setTimeout(connectStatusSocket, delay);
            });

            socket.addEventListener('error', (e) => {
                console.error('WebSocket error:', e);
            });
        }

        function updateUI(data) {
            document.getElementById('status-time').textContent =
                'Updated: ' + new Date(data.timestamp).toLocaleTimeString();

            const daemonIndicator = document.getElementById('daemon-status');
            if (daemonIndicator) {
                daemonIndicator.className = 'status-indicator ' +
                    (data.daemon.running ? 'status-green' : 'status-red');
            }

            // Rigs
            document.getElementById('rigs-list').innerHTML = renderRigsTable(data.rigs);

            // Convoys
            document.getElementById('convoys-list').innerHTML = renderConvoysTable(data.convoys);

            // Agents
            document.getElementById('agents-list').innerHTML = renderAgentsTable(data.agents);

            // Mail status
            document.getElementById('mail-status').innerHTML =
                '<p>Unread: <strong>' + (data.mail.unread || 0) + '</strong></p>' +
                '<p style="margin-top: 8px;"><a href="/mail">Open Mail Center ‚Üí</a></p>';
        }

        async function loadActivity() {
            try {
                const res = await fetch('/api/activity');
                const data = await res.json();
                document.getElementById('activity-list').innerHTML = renderCommitsTable(data.commits);
            } catch (e) {
                document.getElementById('activity-list').innerHTML = '<p class="text-danger">Error: ' + e.message + '</p>';
            }
        }

        async function loadIssues() {
            try {
                const res = await fetch('/api/issues?status=open');
                const data = await res.json();
                document.getElementById('issues-list').innerHTML = renderIssuesTable(data.issues);
            } catch (e) {
                document.getElementById('issues-list').innerHTML = '<p class="text-danger">Error: ' + e.message + '</p>';
            }
        }

        // Initialize
        loadActivity();
        loadIssues();
        setInterval(loadActivity, 30000);
        setInterval(loadIssues, 30000);
        connectStatusSocket();
    </script>
</body>
</html>
