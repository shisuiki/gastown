<!DOCTYPE html>
<html lang="en">
<head>
    {{template "head" .}}
    <title>Accounts - Gas Town</title>
</head>
<body>
    {{template "nav" .}}

    <div class="container account-page">
        <div class="card" style="margin-bottom: 20px;">
            <h2>Account Status</h2>
            <div id="account-status" class="text-muted">Loading...</div>
            <div style="margin-top: 12px;">
                <button id="account-refresh" class="btn btn-secondary btn-sm">Refresh</button>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>Add Account</h2>
                <form id="account-add-form">
                    <div class="form-group">
                        <label for="account-handle">Handle</label>
                        <input id="account-handle" class="input-field" placeholder="work" required>
                    </div>
                    <div class="form-group">
                        <label for="account-email">Email (optional)</label>
                        <input id="account-email" class="input-field" placeholder="you@company.com">
                    </div>
                    <div class="form-group">
                        <label for="account-desc">Description (optional)</label>
                        <input id="account-desc" class="input-field" placeholder="Work account">
                    </div>
                    <button type="submit" class="btn btn-primary">Add Account</button>
                </form>
                <div id="account-add-result" class="text-muted" style="margin-top: 10px;"></div>
            </div>
            <div class="card">
                <h2>Usage Notes</h2>
                <div class="text-muted" style="margin-bottom: 8px;">
                    New sessions use the default account unless GT_ACCOUNT is set.
                </div>
                <div class="text-muted" style="margin-bottom: 8px;">
                    Switching updates ~/.claude to point at the chosen account config.
                    Restart Claude sessions after switching.
                </div>
                <div class="text-muted">
                    Per-command overrides: GT_ACCOUNT=work gt crew start or use --account.
                </div>
            </div>
        </div>

        <div class="card" style="margin-top: 20px;">
            <h2>Accounts</h2>
            <div id="accounts-empty" class="text-muted">No accounts configured.</div>
            <table class="history-table" id="accounts-table" style="margin-top: 10px;">
                <thead>
                    <tr>
                        <th>Handle</th>
                        <th>Email</th>
                        <th>Description</th>
                        <th>Config Dir</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="accounts-body"></tbody>
            </table>
        </div>

        <div class="card" style="margin-top: 20px;">
            <h2>Account Login Session</h2>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 10px;">
                <select id="login-account-select" class="input-field" style="min-width: 200px;"></select>
                <button id="login-start" class="btn btn-primary btn-sm">Start Login Session</button>
                <button id="login-stop" class="btn btn-secondary btn-sm">Stop Session</button>
                <button id="login-send" class="btn btn-warning btn-sm">Send /login</button>
            </div>
            <pre class="terminal-output" id="login-output">Start a login session to authenticate an account.</pre>
            <div id="login-input-area" style="display: none; margin-top: 10px;">
                <textarea id="login-input" class="input-field" rows="2" style="resize: vertical; min-height: 40px; max-height: 200px;" placeholder="Type command and press Enter..."></textarea>
                <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: nowrap;">
                    <button id="login-send-input" class="btn btn-success" style="flex: 1; min-width: 60px; padding: 10px 12px;">Send</button>
                    <button id="login-send-enter" class="btn" style="flex: 1; min-width: 60px; padding: 10px 12px; background: #6366f1; color: white;">Enter</button>
                    <button id="login-send-ctrlc" class="btn btn-danger" style="flex: 1; min-width: 60px; padding: 10px 12px;">Ctrl+C</button>
                </div>
            </div>
        </div>
    </div>

    {{template "scripts" .}}
    <script src="/static/js/terminal.js"></script>
    <script>
        const statusEl = document.getElementById('account-status');
        const tableBody = document.getElementById('accounts-body');
        const emptyEl = document.getElementById('accounts-empty');
        const tableEl = document.getElementById('accounts-table');
        const addForm = document.getElementById('account-add-form');
        const addResult = document.getElementById('account-add-result');
        const refreshBtn = document.getElementById('account-refresh');
        const loginSelect = document.getElementById('login-account-select');
        const loginStartBtn = document.getElementById('login-start');
        const loginStopBtn = document.getElementById('login-stop');
        const loginSendBtn = document.getElementById('login-send');
        const loginSendInputBtn = document.getElementById('login-send-input');
        const loginSendEnterBtn = document.getElementById('login-send-enter');
        const loginSendCtrlBtn = document.getElementById('login-send-ctrlc');
        let accountsCache = [];
        let loginSessionHandle = '';
        let loginTerminal = null;

        function formatSource(source) {
            if (source === 'env') return 'GT_ACCOUNT';
            if (source === 'default') return 'default';
            return 'none';
        }

        function renderStatus(data) {
            if (!data || !data.current_handle) {
                statusEl.textContent = 'No account configured.';
                return;
            }

            const rows = [];
            rows.push('<tr><th>Current</th><td>' + escapeHtml(data.current_handle) + '</td></tr>');
            rows.push('<tr><th>Source</th><td>' + escapeHtml(formatSource(data.current_source)) + '</td></tr>');
            if (Array.isArray(data.accounts)) {
                const current = data.accounts.find(account => account.handle === data.current_handle);
                if (current) {
                    rows.push('<tr><th>Login</th><td>' + (current.logged_in ? 'Logged in' : 'Needs login') + '</td></tr>');
                }
            }
            if (data.current_config_dir) {
                rows.push('<tr><th>Config Dir</th><td>' + escapeHtml(data.current_config_dir) + '</td></tr>');
            }
            if (data.env_account) {
                rows.push('<tr><th>GT_ACCOUNT</th><td>' + escapeHtml(data.env_account) + '</td></tr>');
            }
            if (data.claude_dir) {
                let claudeInfo = data.claude_dir;
                if (data.claude_is_symlink && data.claude_target) {
                    claudeInfo += ' -> ' + data.claude_target;
                }
                rows.push('<tr><th>~/.claude</th><td>' + escapeHtml(claudeInfo) + '</td></tr>');
            }

            statusEl.innerHTML = '<table>' + rows.join('') + '</table>';
        }

        function renderAccounts(data) {
            const accounts = (data && Array.isArray(data.accounts)) ? data.accounts : [];
            accountsCache = accounts;
            updateLoginSelect();
            if (accounts.length === 0) {
                emptyEl.style.display = 'block';
                tableEl.style.display = 'none';
                tableBody.innerHTML = '';
                return;
            }

            emptyEl.style.display = 'none';
            tableEl.style.display = 'table';

            tableBody.innerHTML = accounts.map(account => {
                const badges = [];
                if (account.is_default) {
                    badges.push('<span class="badge badge-green">Default</span>');
                }
                if (account.is_current) {
                    badges.push('<span class="badge badge-blue">Current</span>');
                }
                if (account.logged_in) {
                    badges.push('<span class="badge badge-yellow">Logged in</span>');
                } else {
                    badges.push('<span class="badge badge-red">Needs login</span>');
                }

                const activateDisabled = !account.logged_in ? 'disabled' : '';

                return '<tr>' +
                    '<td>' + escapeHtml(account.handle) + '</td>' +
                    '<td>' + escapeHtml(account.email || '') + '</td>' +
                    '<td>' + escapeHtml(account.description || '') + '</td>' +
                    '<td>' + escapeHtml(account.config_dir || '') + '</td>' +
                    '<td>' + badges.join(' ') + '</td>' +
                    '<td><div class="table-actions">' +
                        '<button class="btn btn-secondary btn-sm" data-action="activate" data-handle="' + escapeHtml(account.handle) + '" ' + activateDisabled + '>Activate</button>' +
                        '<button class="btn btn-warning btn-sm" data-action="login" data-handle="' + escapeHtml(account.handle) + '">Login</button>' +
                    '</div></td>' +
                    '</tr>';
            }).join('');

            tableBody.querySelectorAll('button[data-action]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const action = btn.getAttribute('data-action');
                    const handle = btn.getAttribute('data-handle');
                    if (action === 'activate') {
                        setDefault(handle);
                    } else if (action === 'login') {
                        startLogin(handle);
                    }
                });
            });
        }

        async function loadAccounts() {
            try {
                const res = await fetch('/api/accounts');
                if (!res.ok) {
                    throw new Error(await res.text());
                }
                const data = await res.json();
                renderStatus(data);
                renderAccounts(data);
            } catch (e) {
                statusEl.textContent = 'Failed to load accounts: ' + e.message;
            }
        }

        async function setDefault(handle) {
            try {
                const res = await fetch('/api/accounts/default', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ handle })
                });
                if (!res.ok) {
                    throw new Error(await res.text());
                }
                const data = await res.json();
                renderStatus(data);
                renderAccounts(data);
            } catch (e) {
                alert('Failed to set default: ' + e.message);
            }
        }

        function updateLoginSelect() {
            if (!loginSelect) {
                return;
            }
            const current = loginSelect.value;
            loginSelect.innerHTML = accountsCache.map(account => {
                return '<option value="' + escapeHtml(account.handle) + '">' + escapeHtml(account.handle) + '</option>';
            }).join('');
            if (current && accountsCache.some(a => a.handle === current)) {
                loginSelect.value = current;
            }
        }

        function ensureLoginTerminal() {
            if (loginTerminal) {
                return loginTerminal;
            }
            loginTerminal = new TerminalWidget({
                container: '.account-page',
                outputEl: '#login-output',
                toggleBtn: null,
                inputEl: '#login-input',
                inputArea: '#login-input-area',
                sessionInfoEl: null,
                sessionId: null,
                streamUrl: '/api/terminal/stream',
                sendUrl: '/api/terminal/send',
                showInput: true,
                showSessionInfo: false,
                sendEnter: true
            });
            return loginTerminal;
        }

        async function startLogin(handle) {
            if (!handle) {
                return;
            }
            try {
                const res = await fetch('/api/accounts/login/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ handle })
                });
                if (!res.ok) {
                    throw new Error(await res.text());
                }
                const data = await res.json();
                loginSessionHandle = handle;
                if (loginSelect) {
                    loginSelect.value = handle;
                }
                const terminal = ensureLoginTerminal();
                terminal.sessionId = data.session_id;
                terminal.connect();
            } catch (e) {
                alert('Failed to start login session: ' + e.message);
            }
        }

        async function stopLogin(handle) {
            if (!handle) {
                return;
            }
            try {
                await fetch('/api/accounts/login/stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ handle })
                });
            } catch (e) {
                console.warn('Failed to stop login session:', e);
            }
            if (loginTerminal) {
                loginTerminal.disconnect();
            }
        }

        function sendLoginCommand(cmd) {
            if (!loginTerminal) {
                return;
            }
            const input = document.getElementById('login-input');
            if (!input) {
                return;
            }
            input.value = cmd;
            loginTerminal.sendInput();
        }

        addForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            addResult.textContent = '';

            const handle = document.getElementById('account-handle').value.trim();
            const email = document.getElementById('account-email').value.trim();
            const description = document.getElementById('account-desc').value.trim();

            try {
                const res = await fetch('/api/accounts/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ handle, email, description })
                });
                if (!res.ok) {
                    throw new Error(await res.text());
                }
                const data = await res.json();
                renderStatus(data);
                renderAccounts(data);
                addForm.reset();
                if (data.accounts) {
                    const account = data.accounts.find(a => a.handle === handle);
                    if (account && account.config_dir) {
                        addResult.textContent = 'Added. Login with: CLAUDE_CONFIG_DIR=' + account.config_dir + ' claude (then /login).';
                    }
                }
            } catch (e) {
                addResult.textContent = 'Failed to add account: ' + e.message;
            }
        });

        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => loadAccounts());
        }
        if (loginStartBtn) {
            loginStartBtn.addEventListener('click', () => {
                const handle = loginSelect ? loginSelect.value : '';
                startLogin(handle);
            });
        }
        if (loginStopBtn) {
            loginStopBtn.addEventListener('click', () => {
                const handle = loginSelect ? loginSelect.value : loginSessionHandle;
                stopLogin(handle);
            });
        }
        if (loginSendBtn) {
            loginSendBtn.addEventListener('click', () => sendLoginCommand('/login'));
        }
        if (loginSendInputBtn) {
            loginSendInputBtn.addEventListener('click', () => {
                if (loginTerminal) {
                    loginTerminal.sendInput();
                }
            });
        }
        if (loginSendEnterBtn) {
            loginSendEnterBtn.addEventListener('click', () => {
                if (loginTerminal) {
                    loginTerminal.sendKey('Enter');
                }
            });
        }
        if (loginSendCtrlBtn) {
            loginSendCtrlBtn.addEventListener('click', () => {
                if (loginTerminal) {
                    loginTerminal.sendKey('C-c');
                }
            });
        }

        loadAccounts();
    </script>
</body>
</html>
