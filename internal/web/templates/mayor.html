<!DOCTYPE html>
<html lang="en">
<head>
    {{template "head" .}}
    <title>Mayor Control - Gas Town</title>
</head>
<body>
    {{template "nav" .}}

    <div class="container">
        <div class="card card-highlight" style="margin-bottom: 20px;">
            <h2>üèõÔ∏è Mayor Control <span class="status-indicator" id="mayor-status"></span> <span id="mayor-hook" style="font-size: 0.75rem; margin-left: 10px;" class="text-muted"></span></h2>
            <div class="mayor-grid">
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span class="text-muted" style="font-size: 0.8rem;">Mayor Terminal (hq-mayor)</span>
                        <button id="terminal-toggle" class="btn btn-success btn-sm">Connect</button>
                    </div>
                    <pre class="terminal-output" id="terminal-output" style="min-height: 400px;">Click "Connect" to view Mayor's terminal output.</pre>
                    <div id="terminal-input-area" style="display: none; margin-top: 10px;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="terminal-input" class="input-field" style="flex: 1;" placeholder="Type command and press Enter...">
                            <button onclick="terminal.sendInput()" class="btn btn-success btn-sm">Send</button>
                            <button onclick="terminal.sendKey('C-c')" class="btn btn-danger btn-sm">Ctrl+C</button>
                        </div>
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div class="text-muted" style="font-size: 0.8rem;">Send Mail to Mayor</div>
                    <input type="text" id="mayor-mail-subject" placeholder="Subject" class="input-field">
                    <textarea id="mayor-mail-body" placeholder="Message to Mayor..." rows="8" class="input-field" style="flex: 1;"></textarea>
                    <button onclick="sendMailToMayor()" class="btn btn-primary">üì® Send to Mayor</button>
                    <div id="mayor-mail-result" style="font-size: 0.8rem;" class="text-muted"></div>
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>üìä Mayor Status</h2>
                <table>
                    <tr><th>Session</th><td id="session-status">Checking...</td></tr>
                    <tr><th>Hook Status</th><td id="hook-status">Checking...</td></tr>
                    <tr><th>Pending Mail</th><td id="mail-count">Checking...</td></tr>
                </table>
            </div>
            <div class="card">
                <h2>üí¨ Quick Message</h2>
                <div class="chat-messages" id="chat-messages"></div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chat-input" placeholder="Message to Mayor..." class="input-field" style="flex: 1;">
                    <button onclick="sendMessage()" class="btn btn-primary">Send</button>
                </div>
            </div>
        </div>
    </div>

    {{template "scripts" .}}
    <script src="/static/js/terminal.js"></script>
    <script>
        // ================================================================
        // Mayor Page JavaScript
        // ================================================================

        // Initialize terminal widget with fixed session (hq-mayor)
        const terminal = new TerminalWidget({
            container: '.container',
            outputEl: '#terminal-output',
            toggleBtn: '#terminal-toggle',
            inputEl: '#terminal-input',
            inputArea: '#terminal-input-area',
            sessionId: 'hq-mayor',
            streamUrl: '/api/mayor/terminal',
            sendUrl: '/api/terminal/send',
        });

        async function sendMailToMayor() {
            const subject = document.getElementById('mayor-mail-subject').value.trim();
            const body = document.getElementById('mayor-mail-body').value.trim();
            const result = document.getElementById('mayor-mail-result');

            if (!subject) {
                result.innerHTML = '<span class="text-danger">Please enter a subject</span>';
                return;
            }

            result.innerHTML = '<span class="text-warning">Sending...</span>';

            try {
                const res = await fetch('/api/mail/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ to: 'mayor/', subject, body })
                });
                const data = await res.json();

                if (data.success) {
                    result.innerHTML = '<span class="text-success">‚úì Mail sent to Mayor</span>';
                    document.getElementById('mayor-mail-subject').value = '';
                    document.getElementById('mayor-mail-body').value = '';
                    setTimeout(() => { result.innerHTML = ''; updateMayorStatus(); }, 2000);
                } else {
                    result.innerHTML = '<span class="text-danger">Failed: ' + (data.error || 'Unknown error') + '</span>';
                }
            } catch (e) {
                result.innerHTML = '<span class="text-danger">Error: ' + e.message + '</span>';
            }
        }

        async function updateMayorStatus() {
            try {
                const res = await fetch('/api/mayor/status');
                const data = await res.json();

                document.getElementById('mayor-status').className = 'status-indicator ' +
                    (data.session_exists ? 'status-green' : 'status-red');

                document.getElementById('session-status').innerHTML = data.session_exists
                    ? '<span class="badge badge-green">Active</span>'
                    : '<span class="badge badge-red">Inactive</span>';

                const hookSpan = document.getElementById('mayor-hook');
                if (data.hook && !data.hook.includes('Nothing on hook')) {
                    hookSpan.textContent = 'ü™ù Work hooked';
                    hookSpan.className = 'text-success';
                    document.getElementById('hook-status').innerHTML = '<span class="badge badge-green">Hooked</span>';
                } else {
                    hookSpan.textContent = 'No hook';
                    hookSpan.className = 'text-muted';
                    document.getElementById('hook-status').innerHTML = '<span class="badge badge-yellow">Empty</span>';
                }

                document.getElementById('mail-count').textContent = data.mail_count || '0';
            } catch (e) {
                console.error('Failed to get mayor status:', e);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            addMessage(message, 'sent');
            input.value = '';

            try {
                const res = await fetch('/api/mail/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ to: 'mayor/', subject: 'Web GUI Message', body: message })
                });
                const data = await res.json();
                addMessage(data.success ? 'Message sent to Mayor' : 'Error: ' + data.error, 'received');
            } catch (e) {
                addMessage('Failed: ' + e.message, 'received');
            }
        }

        function addMessage(text, type) {
            const messages = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'message ' + type;
            div.textContent = text;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        // Event listeners
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Initialize
        updateMayorStatus();
        setInterval(updateMayorStatus, 5000);
    </script>
</body>
</html>
