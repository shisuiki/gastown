<!DOCTYPE html>
<html lang="en">
<head>
    {{template "head" .}}
    <title>Activity - Gas Town</title>
</head>
<body>
    {{template "nav" .}}

    <div class="container">
        <div class="card" style="margin-bottom: 20px;">
            <h2>üìù Recent Activity</h2>
            <div id="activity-list" style="max-height: 500px; overflow-y: auto;">Loading...</div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>üöö Active Convoys</h2>
                <div id="convoys-list">Loading...</div>
            </div>
            <div class="card">
                <h2>üìä Stats</h2>
                <table>
                    <tr><th>Total Commits</th><td id="total-commits">-</td></tr>
                    <tr><th>Last Update</th><td id="last-update">-</td></tr>
                </table>
            </div>
        </div>
    </div>

    {{template "scripts" .}}
    <script>
        // ================================================================
        // Activity Page JavaScript
        // ================================================================

        async function loadActivity() {
            try {
                const res = await fetch('/api/activity');
                const data = await res.json();

                document.getElementById('activity-list').innerHTML = renderCommitsTable(data.commits);

                if (data.commits && data.commits.length > 0) {
                    document.getElementById('total-commits').textContent = data.commits.length + ' shown';
                    document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
                }
            } catch (e) {
                document.getElementById('activity-list').innerHTML = '<p class="text-danger">Error: ' + e.message + '</p>';
            }
        }

        async function loadConvoys() {
            try {
                const res = await fetch('/api/convoys');
                const convoys = await res.json();

                if (convoys.error) {
                    document.getElementById('convoys-list').innerHTML = '<p class="text-danger">Error: ' + escapeHtml(convoys.error) + '</p>';
                    return;
                }

                document.getElementById('convoys-list').innerHTML = renderConvoysTable(convoys);
            } catch (e) {
                document.getElementById('convoys-list').innerHTML = '<p class="text-danger">Error: ' + e.message + '</p>';
            }
        }

        // Initialize
        loadActivity();
        loadConvoys();
        setInterval(loadActivity, 30000);
        setInterval(loadConvoys, 30000);
    </script>
</body>
</html>
