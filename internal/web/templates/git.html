<!DOCTYPE html>
<html lang="en">
<head>
    {{template "head" .}}
    <title>Git - Gas Town</title>
    <link rel="stylesheet" href="/static/css/vis-network.min.css">
    <style>
        .git-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .stat-card {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 15px 20px;
            min-width: 120px;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #60a5fa;
        }
        .stat-label {
            font-size: 0.75rem;
            color: #94a3b8;
            text-transform: uppercase;
        }
        .commit-list {
            max-height: 360px;
            overflow-y: auto;
        }
        .commit-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            border-bottom: 1px solid #333;
            transition: background 0.2s;
            cursor: pointer;
        }
        .commit-item:hover {
            background: rgba(255, 255, 255, 0.02);
        }
        .commit-item.selected {
            background: rgba(96, 165, 250, 0.08);
            border-color: rgba(96, 165, 250, 0.3);
        }
        .commit-item:last-child {
            border-bottom: none;
        }
        .commit-hash {
            font-family: monospace;
            color: #60a5fa;
            font-size: 0.85rem;
            min-width: 70px;
        }
        .commit-info {
            flex: 1;
            min-width: 0;
        }
        .commit-message {
            color: #eee;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .commit-meta {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 4px;
        }
        .commit-author {
            color: #94a3b8;
        }
        .detail-card {
            border: 1px solid #333;
            border-radius: 8px;
            padding: 16px;
            background: rgba(15, 23, 42, 0.4);
        }
        .detail-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: #cbd5f5;
        }
        .detail-label {
            color: #64748b;
            min-width: 100px;
        }
        .diff-files {
            margin-top: 12px;
            border-top: 1px solid #333;
            padding-top: 12px;
            font-size: 0.85rem;
        }
        .diff-file {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        }
        .diff-file:last-child {
            border-bottom: none;
        }
        .diff-file-path {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            color: #e2e8f0;
            word-break: break-all;
        }
        .diff-file-stats {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            color: #94a3b8;
            white-space: nowrap;
        }
        .diff-patch {
            margin-top: 12px;
            padding: 12px;
            border-radius: 8px;
            background: #0b1220;
            border: 1px solid #1f2937;
            color: #e2e8f0;
            white-space: pre;
            overflow: auto;
            max-height: 420px;
            max-width: 100%;
            box-sizing: border-box;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.8rem;
        }
        .branch-tag {
            display: inline-block;
            background: #166534;
            color: #4ade80;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 8px;
        }
        .branches-list {
            display: flex;
            flex-direction: column;
            flex-wrap: nowrap;
            gap: 8px;
        }
        .branch-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #0f172a;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #333;
            cursor: pointer;
            width: 100%;
            box-sizing: border-box;
        }
        .branch-item.current {
            border-color: #4ade80;
            background: rgba(74, 222, 128, 0.1);
        }
        .branch-item.active {
            border-color: #60a5fa;
            background: rgba(96, 165, 250, 0.08);
        }
        .branch-name {
            font-family: monospace;
            color: #eee;
        }
        .branch-commit {
            font-size: 0.75rem;
            color: #64748b;
            font-family: monospace;
        }
        .branch-meta {
            font-size: 0.7rem;
            color: #94a3b8;
        }
        .current-indicator {
            color: #4ade80;
            font-size: 0.8rem;
        }
        .tab-nav {
            display: flex;
            gap: 4px;
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        .tab-btn {
            padding: 8px 16px;
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            border-radius: 6px 6px 0 0;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #eee;
        }
        .tab-btn.active {
            background: #3b82f6;
            color: #fff;
        }
        .rig-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .rig-selector select {
            padding: 8px 12px;
            background: #0f172a;
            border: 1px solid #333;
            border-radius: 6px;
            color: #eee;
            font-size: 0.9rem;
        }
        .git-grid {
            display: grid;
            grid-template-columns: 340px 1fr;
            grid-template-rows: minmax(220px, auto) minmax(260px, auto);
            gap: 16px;
        }
        .panel {
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 14px;
        }
        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #94a3b8;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        .branch-panel {
            grid-column: 1;
            grid-row: 1;
        }
        .commit-panel {
            grid-column: 1;
            grid-row: 2;
        }
        .graph-panel {
            grid-column: 2;
            grid-row: 1 / span 2;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .panel-scroll {
            overflow-y: auto;
        }
        .branch-list {
            max-height: 220px;
        }
        .graph-canvas {
            flex: 1;
            height: 520px;
            min-height: 520px;
            border: 1px solid #1f2937;
            border-radius: 8px;
            background: #0b1220;
            overflow: hidden;
            position: relative;
        }
        .tabs-panel {
            margin-top: 18px;
        }
        .tab-content {
            margin-top: 12px;
        }
        .file-toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .file-toolbar input {
            padding: 6px 10px;
            background: #0f172a;
            border: 1px solid #333;
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 0.85rem;
        }
        .file-toolbar select {
            padding: 6px 10px;
            background: #0f172a;
            border: 1px solid #333;
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 0.85rem;
        }
        .file-panel {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 16px;
        }
        .file-list {
            border: 1px solid #333;
            border-radius: 8px;
            padding: 8px 0;
            max-height: 420px;
            overflow-y: auto;
        }
        .file-entry {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            padding: 8px 14px;
            cursor: pointer;
        }
        .file-entry:hover {
            background: rgba(255, 255, 255, 0.04);
        }
        .file-entry.active {
            background: rgba(96, 165, 250, 0.08);
        }
        .file-name {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            color: #e2e8f0;
            word-break: break-all;
        }
        .file-meta {
            font-size: 0.75rem;
            color: #64748b;
            white-space: nowrap;
        }
        .file-view {
            border: 1px solid #333;
            border-radius: 8px;
            padding: 12px;
            background: rgba(15, 23, 42, 0.4);
            max-height: 420px;
            overflow-y: auto;
        }
        .file-breadcrumbs {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            font-size: 0.8rem;
            color: #94a3b8;
            margin-bottom: 8px;
        }
        .file-breadcrumbs button {
            background: none;
            border: none;
            color: #60a5fa;
            cursor: pointer;
            padding: 0;
        }
        @media (max-width: 768px) {
            .git-stats {
                gap: 10px;
            }
            .stat-card {
                flex: 1;
                min-width: 80px;
                padding: 10px;
            }
            .stat-value {
                font-size: 1.2rem;
            }
            .commit-item {
                flex-direction: column;
                gap: 8px;
            }
            .file-panel {
                grid-template-columns: 1fr;
            }
            .git-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
            }
            .graph-panel,
            .branch-panel,
            .commit-panel {
                grid-column: 1;
                grid-row: auto;
            }
            .graph-canvas {
                height: 360px;
                min-height: 360px;
            }
        }
    </style>
</head>
<body x-data="gitPage()">
    {{template "nav" .}}

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 style="font-size: 1.2rem; color: #94a3b8;">Git Repository</h1>
            <div class="rig-selector">
                <label class="text-muted">Repository:</label>
                <select x-model="selectedRig" @change="resetSelection(); loadAll(); loadGraph(true);">
                    <option value="">Town Root (~/gt)</option>
                    <template x-for="rig in rigs" :key="rig.name">
                        <option :value="rig.name" x-text="rig.name + ' (' + rig.repo_dir + ')'"></option>
                    </template>
                </select>
            </div>
        </div>

        <div class="git-stats">
            <div class="stat-card">
                <div class="stat-value" x-text="stats.commits">-</div>
                <div class="stat-label">Commits</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" x-text="stats.branches">-</div>
                <div class="stat-label">Branches</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" x-text="currentBranch || '-'">-</div>
                <div class="stat-label">Current Branch</div>
            </div>
        </div>

        <div class="git-grid">
            <div class="panel branch-panel">
                <div class="panel-header">Branches</div>
                <template x-if="loading.branches">
                    <p class="text-muted">Loading branches...</p>
                </template>
                <template x-if="!loading.branches && branches.length === 0">
                    <p class="text-muted">No branches found</p>
                </template>
                <div class="branches-list panel-scroll branch-list" x-show="!loading.branches && branches.length > 0">
                    <template x-for="branch in branches" :key="branch.name">
                        <div class="branch-item" :class="{ current: branch.is_current, active: selectedBranch === branch.name }" @click="selectBranch(branch)">
                            <template x-if="branch.is_current">
                                <span class="current-indicator">●</span>
                            </template>
                            <span class="branch-name" x-text="branch.name"></span>
                            <span class="branch-commit" x-text="branch.short_commit || branch.last_commit"></span>
                            <template x-if="branch.is_remote">
                                <span class="branch-meta">remote</span>
                            </template>
                            <template x-if="branch.upstream">
                                <span class="branch-meta" x-text="'-> ' + branch.upstream"></span>
                            </template>
                            <template x-if="branch.ahead || branch.behind">
                                <span class="branch-meta" x-text="'up ' + (branch.ahead || 0) + ' down ' + (branch.behind || 0)"></span>
                            </template>
                        </div>
                    </template>
                </div>
            </div>

            <div class="panel commit-panel">
                <div class="panel-header">Commits</div>
                <template x-if="loading.commits">
                    <p class="text-muted">Loading commits...</p>
                </template>
                <template x-if="!loading.commits && commits.length === 0">
                    <p class="text-muted">No commits found</p>
                </template>
                <div class="commit-list panel-scroll" x-show="!loading.commits && commits.length > 0" x-ref="commitList">
                    <template x-for="(commit, index) in commits" :key="commit.hash">
                        <div class="commit-item" :class="{ selected: selectedCommitHash === commit.hash }" @click="selectCommit(commit)" :data-hash="commit.hash">
                            <span class="commit-hash" x-text="commit.short_hash"></span>
                            <div class="commit-info">
                                <div class="commit-message">
                                    <span x-text="commit.message"></span>
                                    <template x-if="commit.branch && index === 0">
                                        <span class="branch-tag" x-text="commit.branch"></span>
                                    </template>
                                </div>
                                <div class="commit-meta">
                                    <span class="commit-author" x-text="commit.author"></span>
                                    <span> · </span>
                                    <span x-text="commit.date"></span>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <div class="panel graph-panel">
                <div class="panel-header">Graph</div>
                <div class="file-toolbar">
                    <label class="text-muted">Graph depth:</label>
                    <input type="number" min="20" max="400" x-model="graphLimit" style="width: 80px;">
                    <button class="tab-btn" style="border-radius: 6px;" @click="loadGraph(true)">Refresh</button>
                </div>
                <template x-if="graphNodes.length === 0">
                    <p class="text-muted">No graph data</p>
                </template>
                <div id="git-graph" class="graph-canvas"></div>
            </div>
        </div>

        <div class="panel tabs-panel">
            <div class="tab-nav">
                <button class="tab-btn" :class="{ active: activeTab === 'changes' }" @click="activeTab = 'changes'">
                    Changes
                </button>
                <button class="tab-btn" :class="{ active: activeTab === 'files' }" @click="activeTab = 'files'; loadFiles()">
                    Files
                </button>
                <button class="tab-btn" :class="{ active: activeTab === 'compare' }" @click="activeTab = 'compare'; loadCompare()">
                    Compare
                </button>
                <button class="tab-btn" :class="{ active: activeTab === 'search' }" @click="activeTab = 'search'">
                    Search
                </button>
            </div>

            <div class="tab-content">
                <div x-show="activeTab === 'changes'">
                    <template x-if="!selectedCommitHash">
                        <p class="text-muted">Select a commit to view details.</p>
                    </template>
                    <template x-if="selectedCommitHash && loading.detail">
                        <p class="text-muted">Loading commit details...</p>
                    </template>
                    <template x-if="selectedCommitHash && !loading.detail && commitDetail">
                        <div class="detail-card">
                            <div>
                                <div class="detail-row">
                                    <span class="detail-label">Commit</span>
                                    <span class="commit-hash" x-text="commitDetail.short_hash"></span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Author</span>
                                    <span x-text="commitDetail.author + ' <' + commitDetail.email + '>'"></span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Date</span>
                                    <span x-text="commitDetail.date"></span>
                                </div>
                                <div class="detail-row" x-show="commitDetail.relative_date">
                                    <span class="detail-label">Relative</span>
                                    <span x-text="commitDetail.relative_date"></span>
                                </div>
                                <div class="detail-row" x-show="commitDetail.parents && commitDetail.parents.length">
                                    <span class="detail-label">Parents</span>
                                    <span x-text="commitDetail.parents.join(', ')"></span>
                                </div>
                                <div class="detail-row" x-show="commitDetail.refs">
                                    <span class="detail-label">Refs</span>
                                    <span x-text="commitDetail.refs"></span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Message</span>
                                    <span x-text="commitDetail.message"></span>
                                </div>
                                <template x-if="commitDetail.body">
                                    <div class="detail-row">
                                        <span class="detail-label">Body</span>
                                        <span x-text="commitDetail.body"></span>
                                    </div>
                                </template>
                            </div>

                            <div class="diff-files" x-show="selectedCommitHash">
                                <div style="display:flex; align-items:center; justify-content:space-between;">
                                    <strong>Files</strong>
                                    <button class="tab-btn" style="border-radius: 6px;" @click="toggleDiff()" x-text="showDiff ? 'Hide diff' : 'Show diff'"></button>
                                </div>
                                <template x-if="loading.diff">
                                    <p class="text-muted">Loading diff...</p>
                                </template>
                                <template x-if="!loading.diff && commitDiff">
                                    <div>
                                        <template x-if="commitDiff.files.length === 0">
                                            <p class="text-muted">No file changes</p>
                                        </template>
                                        <template x-for="file in commitDiff.files" :key="file.path">
                                            <div class="diff-file">
                                                <span class="diff-file-path" x-text="formatFilePath(file)"></span>
                                                <span class="diff-file-stats" x-text="formatFileStats(file)"></span>
                                            </div>
                                        </template>
                                        <template x-if="showDiff && commitDiff.patch">
                                            <pre class="diff-patch" x-text="commitDiff.patch"></pre>
                                        </template>
                                        <template x-if="showDiff && commitDiff.truncated">
                                            <p class="text-muted">Diff truncated for size.</p>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>

                <div x-show="activeTab === 'files'">
                    <div class="file-toolbar">
                        <label class="text-muted">Ref:</label>
                        <input type="text" x-model="fileRef" placeholder="HEAD" @keydown.enter="loadFiles()">
                        <button class="tab-btn" style="border-radius: 6px;" @click="loadFiles()">Load</button>
                    </div>
                    <template x-if="loading.tree">
                        <p class="text-muted">Loading tree...</p>
                    </template>
                    <template x-if="!loading.tree && treeEntries.length === 0">
                        <p class="text-muted">No files found</p>
                    </template>
                    <div class="file-panel" x-show="!loading.tree && treeEntries.length > 0">
                        <div>
                            <div class="file-breadcrumbs">
                                <button @click="loadTree('')">root</button>
                                <template x-for="crumb in breadcrumbParts()" :key="crumb.path">
                                    <span>
                                        /
                                        <button @click="loadTree(crumb.path)" x-text="crumb.name"></button>
                                    </span>
                                </template>
                            </div>
                            <div class="file-list">
                                <template x-if="treePath">
                                    <div class="file-entry" @click="loadTree(parentPath())">
                                        <span class="file-name">..</span>
                                        <span class="file-meta">up</span>
                                    </div>
                                </template>
                                <template x-for="entry in treeEntries" :key="entry.path">
                                    <div class="file-entry" :class="{ active: blob && blob.path === entry.path }" @click="openEntry(entry)">
                                        <span class="file-name" x-text="entry.name"></span>
                                        <span class="file-meta" x-text="entry.type === 'tree' ? 'dir' : formatFileSize(entry.size)"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                        <div class="file-view">
                            <template x-if="loading.blob">
                                <p class="text-muted">Loading file...</p>
                            </template>
                            <template x-if="!loading.blob && !blob">
                                <p class="text-muted">Select a file to preview.</p>
                            </template>
                            <template x-if="!loading.blob && blob">
                                <div>
                                    <div class="detail-row">
                                        <span class="detail-label">Path</span>
                                        <span x-text="blob.path"></span>
                                    </div>
                                    <template x-if="blob.binary">
                                        <p class="text-muted">Binary file - preview not available.</p>
                                    </template>
                                    <template x-if="!blob.binary">
                                        <pre class="diff-patch" style="max-height: 300px;" x-text="blob.content"></pre>
                                    </template>
                                    <template x-if="blob.truncated">
                                        <p class="text-muted">File truncated for size.</p>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <div x-show="activeTab === 'compare'">
                    <div class="file-toolbar">
                        <label class="text-muted">Base:</label>
                        <input type="text" x-model="compareBase" placeholder="origin/main">
                        <label class="text-muted">Head:</label>
                        <input type="text" x-model="compareHead" placeholder="feature-branch">
                        <button class="tab-btn" style="border-radius: 6px;" @click="loadCompare()">Compare</button>
                    </div>
                    <template x-if="loading.compare">
                        <p class="text-muted">Loading compare...</p>
                    </template>
                    <template x-if="!loading.compare && compareCommits.length === 0">
                        <p class="text-muted">No commits in range.</p>
                    </template>
                    <div class="commit-list" x-show="!loading.compare && compareCommits.length > 0">
                        <template x-for="commit in compareCommits" :key="commit.hash">
                            <div class="commit-item">
                                <span class="commit-hash" x-text="commit.short_hash"></span>
                                <div class="commit-info">
                                    <div class="commit-message">
                                        <span x-text="commit.message"></span>
                                    </div>
                                    <div class="commit-meta">
                                        <span class="commit-author" x-text="commit.author"></span>
                                        <span> · </span>
                                        <span x-text="commit.date"></span>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                    <div class="detail-card" x-show="compareDiff">
                        <strong>Diff</strong>
                        <div class="diff-files">
                            <template x-if="compareDiff.files.length === 0">
                                <p class="text-muted">No file changes</p>
                            </template>
                            <template x-for="file in compareDiff.files" :key="file.path">
                                <div class="diff-file">
                                    <span class="diff-file-path" x-text="formatFilePath(file)"></span>
                                    <span class="diff-file-stats" x-text="formatFileStats(file)"></span>
                                </div>
                            </template>
                        </div>
                        <template x-if="compareDiff && compareDiff.patch">
                            <pre class="diff-patch" x-text="compareDiff.patch"></pre>
                        </template>
                        <template x-if="compareDiff && compareDiff.truncated">
                            <p class="text-muted">Diff truncated for size.</p>
                        </template>
                    </div>
                </div>

                <div x-show="activeTab === 'search'">
                    <div class="file-toolbar">
                        <label class="text-muted">Mode:</label>
                        <select x-model="searchMode">
                            <option value="commits">Commits</option>
                            <option value="files">Files</option>
                        </select>
                        <input type="text" x-model="searchQuery" placeholder="Search term" @keydown.enter="loadSearch()">
                        <template x-if="searchMode === 'files'">
                            <input type="text" x-model="searchPath" placeholder="Path filter (optional)">
                        </template>
                        <input type="text" x-model="searchRef" placeholder="Ref (default HEAD)">
                        <button class="tab-btn" style="border-radius: 6px;" @click="loadSearch()">Search</button>
                    </div>
                    <template x-if="loading.search">
                        <p class="text-muted">Searching...</p>
                    </template>
                    <template x-if="!loading.search && searchMode === 'commits'">
                        <div class="commit-list" x-show="searchCommits.length > 0">
                            <template x-for="commit in searchCommits" :key="commit.hash">
                                <div class="commit-item">
                                    <span class="commit-hash" x-text="commit.short_hash"></span>
                                    <div class="commit-info">
                                        <div class="commit-message">
                                            <span x-text="commit.message"></span>
                                        </div>
                                        <div class="commit-meta">
                                            <span class="commit-author" x-text="commit.author"></span>
                                            <span> · </span>
                                            <span x-text="commit.date"></span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>
                    <template x-if="!loading.search && searchMode === 'files'">
                        <div class="file-list" x-show="searchFiles.length > 0">
                            <template x-for="match in searchFiles" :key="match.path + ':' + match.line">
                                <div class="file-entry">
                                    <span class="file-name" x-text="match.path + ':' + match.line"></span>
                                    <span class="file-meta" x-text="match.content"></span>
                                </div>
                            </template>
                        </div>
                    </template>
                    <template x-if="!loading.search && searchMode === 'commits' && searchCommits.length === 0">
                        <p class="text-muted">No commit matches.</p>
                    </template>
                    <template x-if="!loading.search && searchMode === 'files' && searchFiles.length === 0">
                        <p class="text-muted">No file matches.</p>
                    </template>
                </div>
            </div>
        </div>
    </div>

    {{template "scripts" .}}
    <script src="/static/js/vis-network.min.js"></script>
    <script>
        function gitPage() {
            return {
                activeTab: 'changes',
                selectedRig: '',
                rigs: [],
                commits: [],
                branches: [],
                graphNodes: [],
                graphNetwork: null,
                graphLimit: 150,
                commitLimit: 150,
                selectedCommitHash: '',
                selectedBranch: '',
                commitDetail: null,
                commitDiff: null,
                showDiff: false,
                fileRef: '',
                treePath: '',
                treeEntries: [],
                blob: null,
                compareBase: 'origin/main',
                compareHead: '',
                compareCommits: [],
                compareDiff: null,
                searchMode: 'commits',
                searchQuery: '',
                searchRef: '',
                searchPath: '',
                searchCommits: [],
                searchFiles: [],
                currentBranch: '',
                stats: {
                    commits: '-',
                    branches: '-'
                },
                loading: {
                    commits: true,
                    branches: true,
                    detail: false,
                    diff: false,
                    tree: false,
                    blob: false,
                    compare: false,
                    search: false
                },

                init() {
                    this.loadRigs();
                    this.loadAll();
                    this.loadGraph(true);
                    setInterval(() => this.loadCommits(), 30000);
                },

                async loadRigs() {
                    try {
                        const res = await fetch('/api/git/rigs');
                        const data = await res.json();
                        this.rigs = (data.rigs || []).filter(r => r.has_repo);
                    } catch (e) {
                        console.error('Failed to load rigs:', e);
                    }
                },

                loadAll() {
                    this.loadCommits();
                    this.loadBranches();
                },

                async loadCommits() {
                    this.loading.commits = true;
                    try {
                        const params = new URLSearchParams();
                        params.set('count', this.commitLimit);
                        if (this.selectedRig) params.set('rig', this.selectedRig);
                        const url = '/api/git/commits?' + params.toString();
                        const res = await fetch(url);
                        const data = await res.json();
                        this.commits = data.commits || [];
                        this.stats.commits = this.commits.length;
                        if (this.commits.length > 0 && this.commits[0].branch) {
                            this.currentBranch = this.commits[0].branch;
                        }
                        if (this.commits.length > 0 && !this.selectedCommitHash) {
                            this.selectCommit(this.commits[0]);
                        }
                    } catch (e) {
                        console.error('Failed to load commits:', e);
                    }
                    this.loading.commits = false;
                },

                async loadBranches() {
                    this.loading.branches = true;
                    try {
                        const url = '/api/git/branches' + (this.selectedRig ? '?rig=' + this.selectedRig : '');
                        const res = await fetch(url);
                        const data = await res.json();
                        this.branches = data.branches || [];
                        this.stats.branches = this.branches.length;
                        const current = this.branches.find(b => b.is_current);
                        if (current) {
                            this.currentBranch = current.name;
                            if (!this.fileRef) {
                                this.fileRef = current.name;
                            }
                            if (!this.compareHead) {
                                this.compareHead = current.name;
                            }
                            if (!this.searchRef) {
                                this.searchRef = current.name;
                            }
                        }
                    } catch (e) {
                        console.error('Failed to load branches:', e);
                    }
                    this.loading.branches = false;
                },

                async loadGraph(force) {
                    if (!force && this.graphNodes.length > 0) return;
                    if (this.graphLimit !== this.commitLimit) {
                        this.commitLimit = this.graphLimit;
                        this.loadCommits();
                    }
                    try {
                        const params = new URLSearchParams();
                        params.set('count', this.graphLimit);
                        if (this.selectedRig) params.set('rig', this.selectedRig);
                        const res = await fetch('/api/git/graph?' + params.toString());
                        const data = await res.json();
                        this.graphNodes = data.nodes || [];
                        this.buildGraph();
                    } catch (e) {
                        console.error('Failed to load graph:', e);
                    }
                },

                buildGraph() {
                    if (!this.graphNodes.length || typeof vis === 'undefined') return;
                    const container = document.getElementById('git-graph');
                    if (!container) return;
                    const isMobile = window.matchMedia('(max-width: 768px)').matches;
                    const height = isMobile ? 360 : 520;
                    container.style.height = height + 'px';
                    container.style.minHeight = height + 'px';
                    container.style.maxHeight = height + 'px';

                    const nodes = [];
                    const edges = [];
                    const index = new Set();

                    this.graphNodes.forEach((node) => {
                        if (!node.hash) return;
                        index.add(node.hash);
                        const isMerge = node.parents && node.parents.length > 1;
                        nodes.push({
                            id: node.hash,
                            label: node.short_hash,
                            shape: 'dot',
                            size: isMerge ? 10 : 8,
                            color: isMerge ? { background: '#4ade80', border: '#166534' } : { background: '#60a5fa', border: '#1d4ed8' },
                            font: { color: '#e2e8f0', size: 12 },
                            title: node.message || node.hash
                        });
                    });

                    this.graphNodes.forEach((node) => {
                        if (!node.hash || !node.parents) return;
                        node.parents.forEach((parent) => {
                            if (!index.has(parent)) return;
                            edges.push({
                                from: node.hash,
                                to: parent,
                                arrows: '',
                                color: { color: '#3b82f6', opacity: 0.5 }
                            });
                        });
                    });

                    if (this.graphNetwork) {
                        this.graphNetwork.destroy();
                    }

                    const data = {
                        nodes: new vis.DataSet(nodes),
                        edges: new vis.DataSet(edges)
                    };

                    const options = {
                        layout: {
                            hierarchical: {
                                enabled: true,
                                direction: 'UD',
                                sortMethod: 'directed',
                                levelSeparation: 50,
                                nodeSpacing: 120,
                                treeSpacing: 140,
                                blockShifting: true,
                                edgeMinimization: true
                            }
                        },
                        physics: false,
                        interaction: {
                            dragNodes: false,
                            hover: true,
                            dragView: true,
                            zoomView: true
                        }
                    };

                    this.graphNetwork = new vis.Network(container, data, options);
                    this.graphNetwork.on('click', (params) => {
                        if (params.nodes && params.nodes.length) {
                            this.selectCommitByHash(params.nodes[0], true);
                        }
                    });
                    this.graphNetwork.once('stabilized', () => {
                        this.graphNetwork.fit({ animation: { duration: 200, easingFunction: 'easeInOutQuad' } });
                    });
                },

                async selectCommit(commit) {
                    if (!commit || !commit.hash) return;
                    this.selectedCommitHash = commit.hash;
                    this.selectedBranch = '';
                    this.commitDetail = null;
                    this.commitDiff = null;
                    this.showDiff = false;
                    await this.loadCommitDetail(commit.hash);
                    await this.loadCommitDiff(commit.hash);
                    this.focusGraphNode(commit.hash);
                    this.scrollCommitIntoView(commit.hash);
                    this.activeTab = 'changes';
                },

                async selectCommitByHash(hash, focusChanges) {
                    if (!hash) return;
                    const commit = this.commits.find(c => c.hash === hash);
                    if (commit) {
                        await this.selectCommit(commit);
                    } else {
                        this.selectedCommitHash = hash;
                        await this.loadCommitDetail(hash);
                        await this.loadCommitDiff(hash);
                        this.focusGraphNode(hash);
                    }
                    if (focusChanges) {
                        this.activeTab = 'changes';
                    }
                },

                selectBranch(branch) {
                    if (!branch) return;
                    this.selectedBranch = branch.name;
                    const target = branch.commit || branch.last_commit;
                    if (target) {
                        this.focusGraphNode(target);
                        this.scrollCommitIntoView(target);
                    }
                },

                async loadCommitDetail(hash) {
                    this.loading.detail = true;
                    try {
                        const url = '/api/git/commit?hash=' + encodeURIComponent(hash) + (this.selectedRig ? '&rig=' + this.selectedRig : '');
                        const res = await fetch(url);
                        const data = await res.json();
                        this.commitDetail = data.commit || null;
                    } catch (e) {
                        console.error('Failed to load commit detail:', e);
                    }
                    this.loading.detail = false;
                },

                async loadCommitDiff(hash) {
                    this.loading.diff = true;
                    try {
                        const url = '/api/git/commit/diff?hash=' + encodeURIComponent(hash) + (this.selectedRig ? '&rig=' + this.selectedRig : '');
                        const res = await fetch(url);
                        const data = await res.json();
                        this.commitDiff = {
                            files: data.files || [],
                            patch: data.patch || '',
                            truncated: data.truncated || false
                        };
                    } catch (e) {
                        console.error('Failed to load commit diff:', e);
                    }
                    this.loading.diff = false;
                },

                toggleDiff() {
                    this.showDiff = !this.showDiff;
                },

                resetSelection() {
                    this.selectedCommitHash = '';
                    this.selectedBranch = '';
                    this.commitDetail = null;
                    this.commitDiff = null;
                    this.showDiff = false;
                    this.fileRef = '';
                    this.treePath = '';
                    this.treeEntries = [];
                    this.blob = null;
                    this.compareCommits = [];
                    this.compareDiff = null;
                    this.searchCommits = [];
                    this.searchFiles = [];
                    this.graphNodes = [];
                    if (this.graphNetwork) {
                        this.graphNetwork.destroy();
                        this.graphNetwork = null;
                    }
                },

                async loadFiles() {
                    await this.loadTree(this.treePath || '');
                },

                async loadTree(path) {
                    this.loading.tree = true;
                    this.treePath = path || '';
                    this.blob = null;
                    try {
                        const ref = this.fileRef || this.currentBranch || 'HEAD';
                        const params = new URLSearchParams();
                        params.set('ref', ref);
                        if (path) params.set('path', path);
                        if (this.selectedRig) params.set('rig', this.selectedRig);
                        const res = await fetch('/api/git/tree?' + params.toString());
                        const data = await res.json();
                        this.treeEntries = data.entries || [];
                    } catch (e) {
                        console.error('Failed to load tree:', e);
                    }
                    this.loading.tree = false;
                },

                async openEntry(entry) {
                    if (!entry) return;
                    if (entry.type === 'tree') {
                        await this.loadTree(entry.path);
                        return;
                    }
                    await this.loadBlob(entry.path);
                },

                async loadBlob(path) {
                    this.loading.blob = true;
                    this.blob = null;
                    try {
                        const ref = this.fileRef || this.currentBranch || 'HEAD';
                        const params = new URLSearchParams();
                        params.set('ref', ref);
                        params.set('path', path);
                        if (this.selectedRig) params.set('rig', this.selectedRig);
                        const res = await fetch('/api/git/blob?' + params.toString());
                        const data = await res.json();
                        this.blob = data.blob || null;
                    } catch (e) {
                        console.error('Failed to load blob:', e);
                    }
                    this.loading.blob = false;
                },

                breadcrumbParts() {
                    if (!this.treePath) return [];
                    const parts = this.treePath.split('/');
                    const crumbs = [];
                    let current = '';
                    for (const part of parts) {
                        current = current ? current + '/' + part : part;
                        crumbs.push({ name: part, path: current });
                    }
                    return crumbs;
                },

                parentPath() {
                    if (!this.treePath) return '';
                    const parts = this.treePath.split('/');
                    parts.pop();
                    return parts.join('/');
                },

                formatFileSize(size) {
                    if (!size && size !== 0) return '';
                    if (size < 1024) return size + ' B';
                    if (size < 1024 * 1024) return (size / 1024).toFixed(1) + ' KB';
                    return (size / (1024 * 1024)).toFixed(1) + ' MB';
                },

                formatFilePath(file) {
                    if (file.old_path) {
                        return file.old_path + ' -> ' + file.path;
                    }
                    return file.path;
                },

                formatFileStats(file) {
                    if (file.binary) {
                        return file.status + ' (binary)';
                    }
                    const add = file.additions || 0;
                    const del = file.deletions || 0;
                    return file.status + ' +' + add + ' -' + del;
                },

                async loadCompare() {
                    if (!this.compareBase || !this.compareHead) return;
                    this.loading.compare = true;
                    this.compareCommits = [];
                    this.compareDiff = null;
                    try {
                        const params = new URLSearchParams();
                        params.set('base', this.compareBase);
                        params.set('head', this.compareHead);
                        if (this.selectedRig) params.set('rig', this.selectedRig);
                        const res = await fetch('/api/git/compare?' + params.toString());
                        const data = await res.json();
                        this.compareCommits = data.commits || [];
                        this.compareDiff = {
                            files: data.files || [],
                            patch: data.patch || '',
                            truncated: data.truncated || false
                        };
                    } catch (e) {
                        console.error('Failed to load compare:', e);
                    }
                    this.loading.compare = false;
                },

                focusGraphNode(hash) {
                    if (!this.graphNetwork || !hash) return;
                    this.graphNetwork.selectNodes([hash]);
                    this.graphNetwork.focus(hash, {
                        scale: 1.1,
                        animation: { duration: 400, easingFunction: 'easeInOutQuad' }
                    });
                },

                scrollCommitIntoView(hash) {
                    if (!hash || !this.$refs.commitList) return;
                    const el = this.$refs.commitList.querySelector('[data-hash="' + hash + '"]');
                    if (el) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                },

                async loadSearch() {
                    if (!this.searchQuery) return;
                    this.loading.search = true;
                    this.searchCommits = [];
                    this.searchFiles = [];
                    try {
                        const params = new URLSearchParams();
                        params.set('q', this.searchQuery);
                        params.set('mode', this.searchMode);
                        if (this.searchRef) params.set('ref', this.searchRef);
                        if (this.searchPath) params.set('path', this.searchPath);
                        if (this.selectedRig) params.set('rig', this.selectedRig);
                        const res = await fetch('/api/git/search?' + params.toString());
                        const data = await res.json();
                        if (this.searchMode === 'files') {
                            this.searchFiles = data.files || [];
                        } else {
                            this.searchCommits = data.commits || [];
                        }
                    } catch (e) {
                        console.error('Failed to search:', e);
                    }
                    this.loading.search = false;
                }
            };
        }
    </script>
</body>
</html>
