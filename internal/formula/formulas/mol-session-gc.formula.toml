description = """
Clean stale sessions and garbage collect.

Dogs work through molecules (poured from this formula) to clean up dead sessions, orphaned processes, and
other system cruft. This is the garbage collector for Gas Town's runtime:
- Dead tmux sessions (no Claude process)
- Orphaned Claude processes (no tmux parent)
- Stale wisps past retention
- Leftover state files

## Dog Contract

This is infrastructure work. You:
1. Receive gc scope via hook_bead (aggressive or conservative)
2. Identify garbage across the system
3. Safely remove dead state
4. Report what was cleaned
5. Return to kennel

## Variables

| Variable | Source | Description |
|----------|--------|-------------|
| mode | hook_bead | GC mode: 'conservative' (safe) or 'aggressive' (thorough) |

## Safety

GC is destructive. This formula errs on the side of caution:
- Conservative mode: Only obviously dead things
- Aggressive mode: Includes old but possibly-recoverable state

Running `gt doctor --fix --profile session-gc` handles most of this. This formula wraps it with
reporting and multi-rig scope.

## Dog Timeout Protection

Dogs have a 10-minute timeout. This formula is optimized to complete within
that window by:
- Skipping slow operations (beads duplicate cleanup)
- Using timeout wrappers on long-running commands
- Focusing on essential session/process cleanup"""
formula = "mol-session-gc"
version = 2

[squash]
trigger = "on_complete"
template_type = "work"
include_metrics = true

[[steps]]
id = "determine-mode"
title = "Determine GC mode"
description = """
Establish GC aggressiveness level.

**1. Check assignment:**
```bash
gt hook               # Shows mode in hook_bead
```

**2. Mode definitions:**

| Mode | Description | Risk |
|------|-------------|------|
| conservative | Only clearly dead state | Very low |
| aggressive | Includes stale state | Low but non-zero |

**Conservative targets:**
- tmux sessions with no processes
- Claude processes with no tmux parent
- Wisps > 24 hours old

**Aggressive additions:**
- Wisps > 1 hour old
- Branches with no matching polecat
- State files > 7 days old

**Exit criteria:** GC mode determined."""

[[steps]]
id = "preview-cleanup"
title = "Preview what will be cleaned"
needs = ["determine-mode"]
description = """
Identify garbage without removing it yet.

**⚠️ TIMEOUT PROTECTION:**
Use timeouts to prevent this step from blocking dog execution.

**1. Run doctor in preview mode (2-minute timeout):**
```bash
timeout 120 gt doctor -v --profile session-gc 2>&1 || echo "Doctor preview timed out"
# Shows what would be cleaned, doesn't do it
```

**2. Parse doctor output for:**
- orphan-sessions: Tmux sessions to kill
- orphan-processes: Claude processes to terminate
- wisp-gc: Wisps to delete

**3. Additional scans (for aggressive mode, with timeouts):**
```bash
# Old branches (30s timeout)
timeout 30 bash -c '
  git branch --list "polecat/*" 2>/dev/null | while read branch; do
    last_commit=$(git log -1 --format=%ct "$branch" 2>/dev/null)
    echo "Branch: $branch, last_commit: $last_commit"
  done
' || echo "Branch scan timed out"

# Old state files (30s timeout)
timeout 30 find ~/.gt/ -name "*.state" -mtime +7 2>/dev/null | head -50 || true
```

**4. Compile cleanup manifest:**
Record each item to be cleaned with:
- Type (session, process, wisp, branch, state)
- Identifier
- Age
- Reason for cleanup

**Note:** If scans time out, proceed with whatever was found.
Partial cleanup is better than no cleanup.

**Exit criteria:** Cleanup manifest ready (possibly partial), nothing deleted yet."""

[[steps]]
id = "execute-gc"
title = "Execute garbage collection"
needs = ["preview-cleanup"]
description = """
Actually remove the garbage.

**⚠️ TIMEOUT PROTECTION:**
Dogs have a 10-minute timeout. Use timeout wrappers on all operations.
Skip slow operations entirely (beads duplicate cleanup takes 30+ minutes).

**1. Run doctor with fix (5-minute timeout):**
```bash
timeout 300 gt doctor --fix --profile session-gc 2>&1 || echo "Doctor timed out or failed, continuing..."
# This handles sessions, processes, and wisps
# If it times out, continue with partial cleanup
```

**2. Skip beads doctor operations:**
DO NOT run `bd doctor --fix` - it takes 30+ minutes due to duplicate cleanup.
The session/process cleanup from gt doctor is sufficient for dog work.
Beads cleanup should be handled by a separate, longer-running process.

**3. For aggressive mode, additional cleanup (with timeouts):**
```bash
# Old branches (if aggressive mode) - 60s timeout
timeout 60 bash -c '
  git branch --list "polecat/*" 2>/dev/null | while read branch; do
    last_commit=$(git log -1 --format=%ct "$branch" 2>/dev/null || echo 0)
    if [ $(($(date +%s) - last_commit)) -gt 604800 ]; then
      git branch -D "$branch" 2>/dev/null || true
    fi
  done
' || echo "Branch cleanup timed out"

# Old state files (if aggressive mode) - 30s timeout
timeout 30 find ~/.gt/ -name "*.state" -mtime +7 -delete 2>/dev/null || true
```

**4. Track what was deleted:**
Record each item actually removed for the report.

**Safety checks:**
- Never delete active sessions (tmux list-clients)
- Never delete branches with uncommitted polecat work
- Never delete wisps < 1 hour old
- Total execution target: < 8 minutes (buffer for 10-min dog timeout)

**Exit criteria:** Garbage collected (or timed out gracefully)."""

[[steps]]
id = "verify-cleanup"
title = "Verify cleanup was successful"
needs = ["execute-gc"]
description = """
Confirm garbage was actually removed.

**⚠️ TIMEOUT PROTECTION:**
Keep verification quick - dog timeout buffer is limited at this point.

**1. Quick doctor verify (60s timeout):**
```bash
timeout 60 gt doctor -v --profile session-gc 2>&1 | head -50 || echo "Verify timed out"
# Should show no issues (or fewer issues)
```

**2. Check for stragglers (quick checks only):**
```bash
# Tmux sessions
tmux list-sessions 2>/dev/null | wc -l || echo "0"

# Claude processes
pgrep -f claude | wc -l || echo "0"

# Wisps (just count, don't list)
ls .beads-wisp/ 2>/dev/null | wc -l || echo "0"
```

**3. Compare before/after:**
- Sessions before: N → after: M
- Processes before: N → after: M
- Wisps before: N → after: M

**Note:** If execute-gc timed out, verification may show partial results.
This is acceptable - report what was cleaned.

**Exit criteria:** Cleanup verified (or partial verification completed)."""

[[steps]]
id = "report-gc"
title = "Generate GC report"
needs = ["verify-cleanup"]
description = """
Create summary report of garbage collection.

**1. Generate report:**
```markdown
## Session GC Report: [TIMESTAMP]

**Mode**: [MODE]

### Summary
| Type | Before | After | Cleaned |
|------|--------|-------|---------|
| Sessions | X | Y | Z |
| Processes | X | Y | Z |
| Wisps | X | Y | Z |
| Branches | X | Y | Z |
| State files | X | Y | Z |

### Items Cleaned
- [TYPE]: [ID] (age: [AGE], reason: [REASON])
- ... (list each cleaned item)

### Errors
- [ITEM]: [ERROR] (if any)
- None (if no errors)

### Space Recovered
~[BYTES] bytes
```

**2. Send to Deacon:**
```bash
gt mail send deacon/ -s "GC complete: [COUNT] items" \
  -m "[REPORT_CONTENT]"
```

**Exit criteria:** Report sent."""

[[steps]]
id = "return-to-kennel"
title = "Signal completion and return to kennel"
needs = ["report-gc"]
description = """
Signal work complete and return to available pool.

**1. Signal completion to Deacon:**
```bash
gt mail send deacon/ -s "DOG_DONE $(hostname)" -m "Task: session-gc
Mode: [MODE]
Items cleaned: [COUNT]
Space recovered: [BYTES]
Status: COMPLETE

Ready for next assignment."
```

**2. Return to kennel:**
Dog returns to available state in the pool.

**Exit criteria:** Deacon notified, dog ready for next work."""

[vars]
[vars.mode]
description = "GC mode: 'conservative' or 'aggressive'"
default = "conservative"
